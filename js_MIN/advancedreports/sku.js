var _timeStart=500,_defaultCountToRetrive=10,_heightFactor=20,_skuLiPrefix="li_sku_",KEY_CODE_UP=40,KEY_CODE_DOWN=38,KEY_CODE_RETURN=13,KEY_CODE_ESCAPE=27,isIE=-1!==navigator.userAgent.indexOf("MSIE");String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")};var AWAdvancedReportsSkus=Class.create();AWAdvancedReportsSkus.prototype={initialize:function(t){this.input=t.input,this.loader=t.loader,this.dropdown=t.dropdown,this.sku_ul=t.sku_ul,this.url=t.url,this.storeUrl=t.store_url,this.limit=t.limit?t.limit:_defaultCountToRetrive,this.li_template=new Template(t.template,/(^|.|\r|\n)({{(\w+)}})/),this.timer=null,this.ajax=null,this.disable_selector=t.disable_selector,this.active=null,this.skus=new Array,document.observe("dom:loaded",function(){$(this.input)&&($(window.document).observe("keypress",function(t){t.keyCode==KEY_CODE_ESCAPE&&this.closeAdvisor()}.bind(this)),$(window.document).observe("click",function(){this.closeAdvisor()}.bind(this)),$(this.input).observe("keyup",function(t){switch(t.keyCode){case KEY_CODE_UP:this.isClosed()||(this.active=this.getPrevId(),this.renderItems());break;case KEY_CODE_RETURN:this.isClosed()||this.selectSku();break;case KEY_CODE_ESCAPE:this.isClosed()||this.closeAdvisor();break;case KEY_CODE_DOWN:if(!this.isClosed()){this.active=this.getNextId(),this.renderItems();break}default:this.disableRetriving(),this.timer&&(clearTimeout(this.timer),this.timer=null),this.getSku(),""!==this.getSku()&&(this.timer=setTimeout(function(){this.retriveSkus(this.getSku()),this.timer=null}.bind(this),_timeStart))}}.bind(this)))}.bind(this))},isClosed:function(){return null===this.active&&!$(this.dropdown).hasClassName("display")},isActive:function(){return null!==this.active},closeAdvisor:function(){this.active=null,this.skus=new Array,this.showDropDown(!1)},getCaretPos:function(){var t=$(this.input);if(t){if(t.selectionStart)return t.selectionStart;if(document.selection){t.focus();var e=document.selection.createRange();if(null==e)return 0;var i=t.createTextRange(),s=i.duplicate();return i.moveToBookmark(e.getBookmark()),s.setEndPoint("EndToStart",i),s.text.length}}return 0},setCaretTo:function(t){var e=$(this.input);if(e)if(e.createTextRange){var i=e.createTextRange();i.move("character",t),i.select()}else e.selectionStart&&(e.focus(),e.setSelectionRange(t,t))},selectSku:function(){if(!this.isClosed()){var t=this.getItem(this.active);if("undefined"!=typeof t){var e=$(this.input);if(e){var i=e.value;if(i){var s=this.getCaretPos();i=i.split(","),i[this.getSkuIndex()]=t.sku_name,e.value=i.join(","),this.setCaretTo(this.getSkuEndPos(s)),this.storeSelection(t.sku_name)}}}}this.closeAdvisor()},storeSelection:function(t){var t=encode_base64(t);new Ajax.Request(this.prepareUrl(this.storeUrl.replace("{{sku}}",t)),{method:"get",onFailure:function(){}.bind(this),onComplete:function(){}.bind(this),loaderArea:!1})},getPrevId:function(){var t=0;return this.isActive()&&(t=this.getIndex(this.active),t==this.skus.length-1?t=0:t++),_skuLiPrefix+(t+1)},getNextId:function(){var t=this.skus.length-1;return this.isActive()&&(t=this.getIndex(this.active),0==t?t=this.skus.length-1:t--),_skuLiPrefix+(t+1)},fixIEvent:function(t){return isIE?(t.target=t.srcElement,t):t},mouseClick:function(t){t=this.fixIEvent(t);var e=$(t.target);if(e){for(;!$(e).hasClassName("is_li");)e=e.parentNode;this.active=e.id,this.selectSku()}},mouseOver:function(t){t=this.fixIEvent(t);var e=$(t.target);if(e){for(;!$(e).hasClassName("is_li");)e=e.parentNode;this.active=e.id,this.renderItems()}},mouseOut:function(t){t=this.fixIEvent(t),$(t.target)&&$(t.target).hasClassName("product_sku_dropdown_ul")&&(this.active=null,this.renderItems())},renderItems:function(){$$(this.disable_selector).each(function(t){t.removeClassName("active")}.bind(this)),this.isClosed()||$(this.active)&&$(this.active).addClassName("active")},getItem:function(t){var e=this.getIndex(t);return"undefined"!=typeof this.skus[e]?this.skus[e]:{}},getIndex:function(t){return null!=t?t.replace(_skuLiPrefix,"")-1:void 0},getSkuIndex:function(){var t=null;if($(this.input)){var e=$(this.input).value;if(e=e.split(","),e.length>1){var i=0,s=0;do s++,i+=e[s-1].length+1;while(this.getCaretPos()>i);return 44==$(this.input).value.charCodeAt(this.getCaretPos()-1)?s:s-1}return 0}return t},getSkuEndPos:function(t){this.setCaretTo(t);var e=this.getSkuIndex(),i=0;if($(this.input)){var s=$(this.input).value.split(",");if(s.length>1){for(var n=0;e>=n;n++)i+=s[n].length+1;return i-1}return $(this.input).length-1}},getCaretPosInSku:function(){var t=this.getCaretPos(),e=this.getSkuIndex(),i=0;if($(this.input)){var s=$(this.input).value.split(",");if(s.length>1){for(var n=0;e>n;n++)i+=s[n].length+1;return t-i-1}return t}return null},getSku:function(){var t="";return $(this.input)&&(t=$(this.input).value.split(","),t=t[this.getSkuIndex()].slice(0,this.getCaretPosInSku()+1),t=t.trim()),t},showLoader:function(t){var e=$(this.loader),i=$(this.input);e&&(t?(e.addClassName("display"),i.addClassName("loading"),this.moveCaretToEnd(i)):(e.removeClassName("display"),i.removeClassName("loading")))},prepareUrl:function(t){var e=t;return"undefined"!=typeof e?e.replace(/^http[s]{0,1}/,window.location.href.replace(/:[^:].*$/i,"")):t},moveCaretToEnd:function(){},retriveSkus:function(sku){this.showLoader(!0),sku=encode_base64(sku),this.ajax=new Ajax.Request(this.prepareUrl(this.url.replace("{{sku}}",sku).replace("{{limit}}",this.limit)),{method:"get",onSuccess:function(transport){if(transport&&transport.responseText)try{if(response=eval("("+transport.responseText+")"),response.count&&response.count>0){var count=response.count,skus=response.skus;this.displayResult(skus,count,response.sku)}response.error&&console.debug(response.error)}catch(e){response={}}}.bind(this),onFailure:function(){}.bind(this),onComplete:function(){this.ajax=null,this.showLoader(!1)}.bind(this),loaderArea:!1})},disableRetriving:function(){this.showLoader(!1),this.showDropDown(!1),this.closeAdvisor()},displayResult:function(t,e,i){if(t.length){this.showDropDown(!0);var s=$(this.dropdown),n="";this.skus=new Array;for(var r=0;r<t.length;r++)n+=this.li_template.evaluate(this.registerNewSku(t[r],i));var o=$(this.sku_ul);o&&(o.innerHTML=n);var a=0;$$("#"+this.dropdown+" ul li.is_li").each(function(t){$("overlay_"+$(t).id).style.height=($(t).getHeight()?$(t).getHeight():0)+"px",$("overlay_"+$(t).id).style.top=a+"px",a+=$(t).getHeight()?$(t).getHeight():0}.bind(this)),s&&(s.style.height=a+"px")}},registerNewSku:function(t,e){var i=this.skus.length+1,s=t.slice(t.toUpperCase().indexOf(e.toUpperCase(),0),t.toUpperCase().indexOf(e.toUpperCase(),0)+e.length),n={sku_id:_skuLiPrefix+i,sku_name:t,sku_title:t.replace(e,'<span class="search" id="span_span_'+_skuLiPrefix+i+'" >'+s+"</span>","i")};return this.skus.push(n),n},showDropDown:function(t){var e=$(this.dropdown);e&&(t?(_submitEnabled=!1,e.addClassName("display")):(_submitEnabled=!0,e.removeClassName("display")))}};