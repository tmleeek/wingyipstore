window.DPD||(window.DPD={}),DPD.Shipping=Class.create({initialize:function(e,i){"DPD_window_content"==e?(this.iframe=window.parent.document.getElementById("DPD_window_content"),innerDoc=this.iframe.contentDocument||this.iframe.contentWindow.document,this.container=innerDoc.getElementById("parcelshop")):this.container=$(e),this.config=i,this.showParcelsLinkClick=this.displayParcelsInline.bind(this),this.saveParcelShopClick=this.saveParcelShop.bind(this),this.invalidateParcelLinkClick=this.invalidateParcel.bind(this),this.saveShipping=this.updateProgressBlock.bind(this),this.showExtraInfoHover=this.showExtraInfo.bind(this),this.container.down("#map_canvas")&&this.initGmaps(),this.container.down(".parcelshoplogo")&&(this.container.down("#s_method_dpdparcelshops_dpdparcelshops").checked=!0,this.setParcelshopImage()),this.bindEvents()},bindEvents:function(){this.showParcelsLink=this.container.down("#showparcels"),this.showParcelsLink&&this.showParcelsLink.observe("click",this.showParcelsLinkClick),this.shippingRadioButtons=$("checkout-shipping-method-load"),this.shippingRadioButtons&&this.shippingRadioButtons.observe("change",this.saveShipping),this.showInfo=this.container.down(".extrainfo"),this.showInfo&&this.showInfo.observe("click",this.showExtraInfoHover),this.parcelShopLink=$$(".parcelshoplink");var e=this.saveParcelShopClick;this.parcelShopLink&&this.parcelShopLink.each(function(i){i.observe("click",e)}),this.invalidateParcelsLink=this.container.down(".invalidateParcel"),this.invalidateParcelsLink&&this.invalidateParcelsLink.observe("click",this.invalidateParcelLinkClick),this.closeGoogleMapsLink=this.container.down(".dpd_close_map"),this.closeGoogleMapsLink&&this.closeGoogleMapsLink.observe("click",function(e){e.preventDefault(),shipping.save()})},displayParcelsInline:function(){this.container.down("#s_method_dpdparcelshops_dpdparcelshops").checked=!0;var e=this.container.down(".dialog");if(this.config.gmapsDisplay&&!e)showDPDWindow(this.config.windowParcelUrl+"?windowed=true","iframe",parseInt(this.config.gmapsWidth.replace("px",""))+40,parseInt(this.config.gmapsHeight.replace("px",""))+40,this.config);else if(this.parcelselectLink=this.container.down("#showparcels"),this.parcelselectLink){var i=(this.config.loaderimage,this.config.ParcelUrl);this.parcelselectLink.replace('<div class="dpdloaderwrapper"><span class="dpdloader"></span>'+this.config.loadingmessage+'</div><input type="hidden" class="DPD-confirmed" value="0"/>'),new parent.Ajax.Updater({success:"dpd"},i,{type:"GET",asynchronous:!0,evalScripts:!0,onComplete:function(){this.initGmaps()}})}},initGmaps:function(){this.mapcanvas=this.container.down("#map_canvas"),this.shops=this.container.down(".shops"),this.wrapper=this.container.down("#parcelshop");"parcelshop"==this.container.id&&(this.wrapper=this.container),this.wrapper.style.height=this.config.gmapsHeight,this.wrapper.style.width=this.config.gmapsWidth,this.map_options={mapTypeId:google.maps.MapTypeId.ROAsetParcelshopImageDMAP};var e=new google.maps.Map(this.mapcanvas,this.map_options),i=(new google.maps.Geocoder,this.config),s=new google.maps.MarkerImage(i.gmapsIcon,new google.maps.Size(57,55),new google.maps.Point(0,0),new google.maps.Point(0,55)),n=new google.maps.MarkerImage(i.gmapsIconShadow,new google.maps.Size(85,55),new google.maps.Point(0,0),new google.maps.Point(0,55)),o=i.gmapsCustomIcon,a=new google.maps.InfoWindow({maxWidth:"400px;"});window.markers=new Array;var t=new google.maps.LatLngBounds;$H(i).each(function(i){if(-1!=i.key.indexOf("shop")){var p=i.value.gmapsMarkerContent;if(i.value.special&&""!=o)var r=new google.maps.Marker({map:e,position:new google.maps.LatLng(i.value.gmapsCenterlat,i.value.gmapsCenterlng),icon:o});else{var r=new google.maps.Marker({map:e,position:new google.maps.LatLng(i.value.gmapsCenterlat,i.value.gmapsCenterlng),icon:s,shadow:n});i.value.special||t.extend(new google.maps.LatLng(i.value.gmapsCenterlat,i.value.gmapsCenterlng))}window.markers.push(r),google.maps.event.addListener(r,"click",function(i){return function(){a.setContent(p),a.open(e,i)}}(r))}e.fitBounds(t)}),this.shops&&(this.shops.scrollTop=1,this.checkInfoClick())},saveParcelShop:function(e){if("parcelshop"==this.container.id){var i=e.target.id;setTimeout(function(){parent.Windows.close("DPD_window",e)},1),this.container=window.parent.document.getElementById("checkout-shipping-method-load")}else var i=e.target.id;i||(i=e.target.parentNode.id),this.container.down("#s_method_dpdparcelshops_dpdparcelshops").checked=!0;var s=this.config.saveParcelUrl,n=this.config[i],o=(this.config.loaderimage,this.container.down("#parcelshop"));o.update('<div class="dpdloaderwrapper" style="margin-bottom:35px;"><span class="dpdloader"></span><span class="message"></span></div><input type="hidden" class="DPD-confirmed" value="0"/>'),new parent.Ajax.Request(s,{method:"POST",asynchronous:!1,evalScripts:!0,parameters:n,onSuccess:function(e){this.container.down("#dpd").update(e.responseText);var i=this.container.down("#custom-shipping-amount").value,s=this.container.down('label[for="s_method_dpdparcelshops_dpdparcelshops"] span'),n=s.innerHTML;s.update(i),i.substring(1)!=n.substring(1)&&(s.addClassName("price-changed"),parent.setTimeout(function(){s.removeClassName("price-changed")}.bind(this),2e3))}.bind(this)})},invalidateParcel:function(){var e=this.config.invalidateParcelUrl,i=(this.config.loaderimage,this.container.down("#parcelshop")),s=this.container.down(".dialog");this.container.down("#s_method_dpdparcelshops_dpdparcelshops").checked=!0,this.config.gmapsDisplay&&!s?(this.container.down("#s_method_dpdparcelshops_dpdparcelshops").checked=!0,showDPDWindow(this.config.windowParcelUrl+"?windowed=true","iframe",parseInt(this.config.gmapsWidth.replace("px",""))+40,parseInt(this.config.gmapsHeight.replace("px",""))+40,this.config)):(i.update('<div class="dpdloaderwrapper"><span class="dpdloader"></span>'+this.config.loadingmessage+'</div><input type="hidden" class="DPD-confirmed" value="0"/>'),new parent.Ajax.Updater({success:this.container.down("#dpd")},e,{type:"GET",asynchronous:!0,evalScripts:!0}))},showExtraInfo:function(e){if(this.container.down(".extrainfowrapper").visible())this.container.down(".extrainfowrapper").hide();else{{var i=e.target.offsetLeft;this.container.down(".extrainfowrapper")}this.container.down(".extrainfowrapper").show().setStyle({left:i+"px"})}},checkInfoClick:function(){this.showInfoBubble=$$(".show-info-bubble"),this.showInfoBubble&&this.showInfoBubble.each(function(e){e.observe("click",function(){marker=window.markers[this.id],google.maps.event.trigger(marker,"click")})})},setParcelshopImage:function(){var e="shop"+this.container.down(".parcelshopId").value;this.config[e]&&this.config[e].special&&""!=this.config[e].specialImage&&(this.container.down(".parcelshoplogo").src=this.config[e].specialImage)},updateProgressBlock:function(){var e=$$('#checkout-progress-wrapper a[href="#shipping_method"]')[0];if(e||(e=$$('.opc-block-progress a[href="#shipping_method"]')[0]),void 0!=e&&!$("s_method_dpdparcelshops_dpdparcelshops").checked&&e.up().next().innerHTML){new Ajax.Request(shipping.saveUrl,{method:"post",onSuccess:checkout.reloadProgressBlock(),parameters:Form.serialize(shipping.form)})}}});