var VarienRulesForm=new Class.create;VarienRulesForm.prototype={initialize:function(e,t){this.parent=$(e),this.newChildUrl=t,this.shownElement=null,this.updateElement=null,this.chooserSelectedItems=$H({}),this.readOnly=!1;for(var s=this.parent.getElementsByClassName("rule-param"),n=0;n<s.length;n++)this.initParam(s[n])},setReadonly:function(e){this.readOnly=e;for(var t=this.parent.getElementsByClassName("rule-param-remove"),s=0;s<t.length;s++){var n=t[s];this.readOnly?n.hide():n.show()}for(var t=this.parent.getElementsByClassName("rule-param-new-child"),s=0;s<t.length;s++){var n=t[s];this.readOnly?n.hide():n.show()}for(var t=this.parent.getElementsByClassName("rule-param"),s=0;s<t.length;s++){var i=t[s],l=Element.down(i,".label");l&&(this.readOnly?l.addClassName("label-disabled"):l.removeClassName("label-disabled"))}},initParam:function(e){e.rulesObject=this;var t=Element.down(e,".label");t&&Event.observe(t,"click",this.showParamInputField.bind(this,e));var s=Element.down(e,".element");if(s){var n=s.down(".rule-chooser-trigger");n&&Event.observe(n,"click",this.toggleChooser.bind(this,e));var i=s.down(".rule-param-apply");i?Event.observe(i,"click",this.hideParamInputField.bind(this,e)):(s=s.down(".element-value-changer"),s.container=e,s.multiple||Event.observe(s,"change",this.hideParamInputField.bind(this,e)),Event.observe(s,"blur",this.hideParamInputField.bind(this,e)))}var l=Element.down(e,".rule-param-remove");l&&Event.observe(l,"click",this.removeRuleEntry.bind(this,e))},showChooserElement:function(e){if(this.chooserSelectedItems=$H({}),e.hasClassName("no-split"))this.chooserSelectedItems.set(this.updateElement.value,1);else{var t=this.updateElement.value.split(","),s="";for(i=0;i<t.length;i++)s=t[i].strip(),""!=s&&this.chooserSelectedItems.set(s,1)}new Ajax.Request(e.getAttribute("url"),{evalScripts:!0,parameters:{form_key:FORM_KEY,"selected[]":this.chooserSelectedItems.keys()},onSuccess:function(t){this._processSuccess(t)&&($(e).update(t.responseText),this.showChooserLoaded(e,t))}.bind(this),onFailure:this._processFailure.bind(this)})},showChooserLoaded:function(e){e.style.display="block"},showChooser:function(e){var t=e.up("li");t&&(t=t.down(".rule-chooser"),t&&this.showChooserElement(t))},hideChooser:function(e){var t=e.up("li");t&&(t=t.down(".rule-chooser"),t&&(t.style.display="none"))},toggleChooser:function(e,t){if(this.readOnly)return!1;var s=e.up("li").down(".rule-chooser");s&&("block"==s.style.display?(s.style.display="none",this.cleanChooser(e,t)):this.showChooserElement(s))},cleanChooser:function(e){var t=e.up("li").down(".rule-chooser");t&&(t.innerHTML="")},showParamInputField:function(e,t){if(this.readOnly)return!1;this.shownElement&&this.hideParamInputField(this.shownElement,t),Element.addClassName(e,"rule-param-edit");var s=Element.down(e,".element"),n=Element.down(s,"input.input-text");n&&(n.focus(),n&&n.id&&n.id.match(/__value$/)&&(this.updateElement=n));var n=Element.down(s,".element-value-changer");n&&n.focus(),this.shownElement=e},hideParamInputField:function(e,t){Element.removeClassName(e,"rule-param-edit");var s,n=Element.down(e,".label");if(e.hasClassName("rule-param-new-child"))s=Element.down(e,".element-value-changer"),s.value&&this.addRuleNewChild(s),s.value="";else{if(s=Element.down(e,".element-value-changer"),s&&s.options){var l=[];for(i=0;i<s.options.length;i++)s.options[i].selected&&l.push(s.options[i].text);var a=l.join(", ");n.innerHTML=""!=a?a:"..."}if(s=Element.down(e,"input.input-text")){var a=s.value.replace(/(^\s+|\s+$)/g,"");s.value=a,""==a?a="...":a.length>30&&(a=a.substr(0,30)+"..."),n.innerHTML=a.escapeHTML()}}s&&s.id&&s.id.match(/__value$/)&&(this.hideChooser(e,t),this.updateElement=null),this.shownElement=null},addRuleNewChild:function(e){var t,s=e.id.replace(/^.*__(.*)__.*$/,"$1"),n=$(e.id.replace(/__/g,":").replace(/[^:]*$/,"children").replace(/:/g,"__")),i=0,l=Selector.findChildElements(n,$A(["input.hidden"]));l.length&&l.each(function(e){e.id.match(/__type$/)&&(t=1*e.id.replace(/^.*__.*?([0-9]+)__.*$/,"$1"),i=t>i?t:i)});var a=s+"--"+(i+1),r=e.value,o=document.createElement("LI");o.className="rule-param-wait",o.innerHTML=Translator.translate("Please wait, loading..."),n.insertBefore(o,$(e).up("li")),new Ajax.Request(this.newChildUrl,{evalScripts:!0,parameters:{form_key:FORM_KEY,type:r.replace("/","-"),id:a},onComplete:this.onAddNewChildComplete.bind(this,o),onSuccess:function(e){this._processSuccess(e)&&$(o).update(e.responseText)}.bind(this),onFailure:this._processFailure.bind(this)})},_processSuccess:function(e){if(e.responseText.isJSON()){var t=e.responseText.evalJSON();return t.error&&alert(t.message),t.ajaxExpired&&t.ajaxRedirect&&setLocation(t.ajaxRedirect),!1}return!0},_processFailure:function(){location.href=BASE_URL},onAddNewChildComplete:function(e){if(this.readOnly)return!1;$(e).removeClassName("rule-param-wait");for(var t=e.getElementsByClassName("rule-param"),s=0;s<t.length;s++)this.initParam(t[s])},removeRuleEntry:function(e){var t=Element.up(e,"li");t.parentNode.removeChild(t)},chooserGridInit:function(){},chooserGridRowInit:function(e){e.reloadParams||(e.reloadParams={"selected[]":this.chooserSelectedItems.keys()})},chooserGridRowClick:function(e,t){var s=Event.findElement(t,"tr"),n="INPUT"==Event.element(t).tagName;if(s){var i=Element.select(s,"input");if(i[0]){var l=n?i[0].checked:!i[0].checked;e.setCheckboxChecked(i[0],l)}}},chooserGridCheckboxCheck:function(e,t,s){s?t.up("th")||this.chooserSelectedItems.set(t.value,1):this.chooserSelectedItems.unset(t.value),e.reloadParams={"selected[]":this.chooserSelectedItems.keys()},this.updateElement.value=this.chooserSelectedItems.keys().join(", ")}};