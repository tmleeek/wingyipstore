var AdminOrder=new Class.create;AdminOrder.prototype={initialize:function(e){e||(e={}),this.loadBaseUrl=!1,this.customerId=e.customer_id?e.customer_id:!1,this.storeId=e.store_id?e.store_id:!1,this.currencyId=!1,this.currencySymbol=e.currency_symbol?e.currency_symbol:"",this.addresses=e.addresses?e.addresses:$H({}),this.shippingAsBilling=e.shippingAsBilling?e.shippingAsBilling:!1,this.gridProducts=$H({}),this.gridProductsGift=$H({}),this.billingAddressContainer="",this.shippingAddressContainer="",this.isShippingMethodReseted=e.shipping_method_reseted?e.shipping_method_reseted:!1,this.overlayData=$H({}),this.giftMessageDataChanged=!1,this.productConfigureAddFields={},this.productPriceBase={},this.collectElementsValue=!0,Event.observe(window,"load",function(){this.dataArea=new OrderFormArea("data",$(this.getAreaId("data")),this),this.itemsArea=Object.extend(new OrderFormArea("items",$(this.getAreaId("items")),this),{addControlButton:function(e){var t=$(this.node).select(".form-buttons")[0];if("undefined"!=typeof t){for(var i=t.childElements(),a=0;a<i.length;a++)if(i[a].innerHTML.include(e.label))return;e.insertIn(t,"top")}}});var e=new ControlButton(Translator.translate("Add Products")),t=this.getAreaId("search");e.onClick=function(){$(t).show();var e=this;window.setTimeout(function(){e.remove()},10)},this.dataArea.onLoad=this.dataArea.onLoad.wrap(function(e){e(),this._parent.itemsArea.setNode($(this._parent.getAreaId("items"))),this._parent.itemsArea.onLoad()}),this.itemsArea.onLoad=this.itemsArea.onLoad.wrap(function(i){i(),$(t).visible()||this.addControlButton(e)}),this.areasLoaded(),this.itemsArea.onLoad()}.bind(this))},areasLoaded:function(){},itemsLoaded:function(){},dataLoaded:function(){this.dataShow()},setLoadBaseUrl:function(e){this.loadBaseUrl=e},setAddresses:function(e){this.addresses=e},setCustomerId:function(e){this.customerId=e,this.loadArea("header",!0),$(this.getAreaId("header")).callback="setCustomerAfter",$("back_order_top_button").hide(),$("reset_order_top_button").show()},setCustomerAfter:function(){this.customerSelectorHide(),this.storeId?($(this.getAreaId("data")).callback="dataLoaded",this.loadArea(["data"],!0)):this.storeSelectorShow()},setStoreId:function(e){this.storeId=e,this.storeSelectorHide(),this.sidebarShow(),this.dataShow(),this.loadArea(["header","data"],!0)},setCurrencyId:function(e){this.currencyId=e,this.loadArea(["data"],!0)},setCurrencySymbol:function(e){this.currencySymbol=e},selectAddress:function(e,t){id=e.value,0==id.length&&(id="0"),this.addresses[id]?this.fillAddressFields(t,this.addresses[id]):this.fillAddressFields(t,{});var i=this.serializeData(t);i[e.name]=id,this.isShippingField(t)&&!this.isShippingMethodReseted?this.resetShippingMethod(i):this.saveData(i)},isShippingField:function(e){return e.include(this.shippingAsBilling?"billing":"shipping")},isBillingField:function(e){return e.include("billing")},bindAddressFields:function(e){for(var t=$(e).select("input","select","textarea"),i=0;i<t.length;i++)Event.observe(t[i],"change",this.changeAddressField.bind(this))},changeAddressField:function(e){var t=Event.element(e),i=/[^\[]*\[([^\]]*)_address\]\[([^\]]*)\](\[(\d)\])?/,a=t.name.match(i);if(a){var s,n=a[1],r=a[2];s=this.serializeData(this.isBillingField(t.id)?this.billingAddressContainer:this.shippingAddressContainer),s=s.toObject(),("billing"==n&&this.shippingAsBilling&&!this.isShippingMethodReseted||"shipping"==n&&!this.shippingAsBilling&&!this.isShippingMethodReseted)&&(s.reset_shipping=!0),s["order["+n+"_address][customer_address_id]"]=$("order-"+n+"_address_customer_address_id").value,"billing"==n&&this.shippingAsBilling&&this.copyDataFromBillingToShipping(t),s.reset_shipping?this.resetShippingMethod(s):(this.saveData(s),this.isShippingMethodReseted||"country_id"!=r&&"customer_address_id"!=r||this.loadArea(["shipping_method","billing_method","totals","items"],!0,s))}},copyDataFromBillingToShipping:function(e){var t=$(e).identify().replace("-billing_","-shipping_"),i=$(t);i&&(i.setValue($(e).getValue()),i.changeUpdater&&i.changeUpdater(),$(this.shippingAddressContainer).select("select").each(function(e){e.disable()}))},fillAddressFields:function(e,t){for(var i=$(e).select("input","select","textarea"),a=/[^\[]*\[[^\]]*\]\[([^\]]*)\](\[(\d)\])?/,s=0;s<i.length;s++)if("input"!=i[s].tagName.toLowerCase()||"file"!=i[s].type.toLowerCase()){var n=i[s].name.match(a);if(null!==n){var r=n[1],o=n[3];if(o)if(t[r]){var d=t[r].split("\n");i[s].value=d[o]?d[o]:""}else i[s].value="";else"select"==i[s].tagName.toLowerCase()&&i[s].multiple?t[r]&&(d=[""],Object.isString(t[r])?d=t[r].split(","):Object.isArray(t[r])&&(d=t[r]),i[s].setValue(d)):i[s].setValue(t[r]?t[r]:"");i[s].changeUpdater&&i[s].changeUpdater(),"region"==r&&t.region_id&&!t.region&&(i[s].value=t.region_id)}}},disableShippingAddress:function(e){if(this.shippingAsBilling=e,$("order-shipping_address_customer_address_id")&&($("order-shipping_address_customer_address_id").disabled=e),$(this.shippingAddressContainer)){for(var t=$(this.shippingAddressContainer).select("input","select","textarea"),i=0;i<t.length;i++)t[i].disabled=e;var a=$(this.shippingAddressContainer).select("button");for(i=0;i<a.length;i++)a[i].disabled=e,e?a[i].addClassName("disabled"):a[i].removeClassName("disabled")}},turnOffShippingFields:function(){if($(this.shippingAddressContainer))for(var e=$(this.shippingAddressContainer).select("input","select","textarea","button"),t=0;t<e.length;t++)e[t].removeAttribute("name"),e[t].removeAttribute("id"),e[t].readOnly=!0},setShippingAsBilling:function(e){if(this.disableShippingAddress(e),e)var t=this.serializeData(this.billingAddressContainer);else var t=this.serializeData(this.shippingAddressContainer);t=t.toObject(),t.shipping_as_billing=e?1:0,t.reset_shipping=1,this.loadArea(["shipping_method","billing_method","shipping_address","totals","giftmessage"],!0,t)},resetShippingMethod:function(e){e.reset_shipping=1,this.isShippingMethodReseted=!0,this.loadArea(["shipping_method","billing_method","totals","giftmessage","items"],!0,e)},loadShippingRates:function(){this.isShippingMethodReseted=!1,this.loadArea(["shipping_method","totals"],!0,{collect_shipping_rates:1})},setShippingMethod:function(e){var t={};t["order[shipping_method]"]=e,this.loadArea(["shipping_method","totals","billing_method"],!0,t)},switchPaymentMethod:function(e){this.setPaymentMethod(e);var t={};t["order[payment_method]"]=e,this.loadArea(["card_validation"],!0,t)},setPaymentMethod:function(e){if(this.paymentMethod&&$("payment_form_"+this.paymentMethod)){var t="payment_form_"+this.paymentMethod;[t+"_before",t,t+"_after"].each(function(e){var t=$(e);t&&(t.hide(),t.select("input","select","textarea").each(function(e){e.disabled=!0}))})}if((!this.paymentMethod||e)&&$("order-billing_method_form").select("input","select","textarea").each(function(e){"radio"!=e.type&&(e.disabled=!0)}),$("payment_form_"+e)){this.paymentMethod=e;var t="payment_form_"+e;[t+"_before",t,t+"_after"].each(function(i){var a=$(i);a&&(a.show(),a.select("input","select","textarea").each(function(a){a.disabled=!1,i.include("_before")||i.include("_after")||a.bindChange||(a.bindChange=!0,a.paymentContainer=t,a.method=e,a.observe("change",this.changePaymentData.bind(this)))},this))},this)}},changePaymentData:function(e){var t=Event.element(e);if(t&&t.method){var i=this.getPaymentData(t.method);if(!i)return;this.loadArea(["card_validation"],!0,i)}},getPaymentData:function(e){if("undefined"==typeof e){if(!this.paymentMethod)return!1;e=this.paymentMethod}for(var t={},i=$("payment_form_"+e).select("input","select"),a=0;a<i.length;a++)t[i[a].name]=i[a].getValue();return"undefined"==typeof t["payment[cc_type]"]||t["payment[cc_type]"]&&t["payment[cc_number]"]?t:!1},applyCoupon:function(e){this.loadArea(["items","shipping_method","totals","billing_method"],!0,{"order[coupon][code]":e,reset_shipping:!0})},addProduct:function(e){this.loadArea(["items","shipping_method","totals","billing_method"],!0,{add_product:e,reset_shipping:!0})},removeQuoteItem:function(e){this.loadArea(["items","shipping_method","totals","billing_method"],!0,{remove_item:e,from:"quote",reset_shipping:!0})},moveQuoteItem:function(e,t){this.loadArea(["sidebar_"+t,"items","shipping_method","totals","billing_method"],this.getAreaId("items"),{move_item:e,to:t,reset_shipping:!0})},productGridShow:function(e){this.productGridShowButton=e,Element.hide(e),this.showArea("search")},productGridRowInit:function(e,t){var i=$(t).select(".checkbox")[0],a=$(t).select(".input-text");if(i&&a.length>0){i.inputElements=a;for(var s=0;s<a.length;s++){var n=a[s];n.checkboxElement=i;var r=this.gridProducts.get(i.value);if(r){var o=r[n.name];o&&("giftmessage"==n.name?n.checked=!0:n.value=o)}n.disabled=!i.checked||n.hasClassName("input-inactive"),Event.observe(n,"keyup",this.productGridRowInputChange.bind(this)),Event.observe(n,"change",this.productGridRowInputChange.bind(this))}}},productGridRowInputChange:function(e){var t=Event.element(e);t&&t.checkboxElement&&t.checkboxElement.checked&&("giftmessage"!=t.name||t.checked?this.gridProducts.get(t.checkboxElement.value)[t.name]=t.value:"giftmessage"==t.name&&this.gridProducts.get(t.checkboxElement.value)[t.name]&&delete this.gridProducts.get(t.checkboxElement.value)[t.name])},productGridRowClick:function(e,t){var i=Event.findElement(t,"tr"),a=i.select('input[name="qty"]')[0],s=Event.element(t),n="INPUT"==s.tagName&&"checkbox"==s.type,r="INPUT"==s.tagName&&"qty"==s.name;if(i&&!r){var o=Element.select(i,'input[type="checkbox"]')[0],d=Element.select(i,"a")[0],l=Element.select(i,".price")[0];if(o)if(d.readAttribute("disabled")){var h=n?o.checked:!o.checked;e.setCheckboxChecked(o,h)}else if(n&&!o.checked)e.setCheckboxChecked(o,!1);else if(!n||n&&o.checked){var c=d.readAttribute("list_type"),u=d.readAttribute("product_id");if("undefined"==typeof this.productPriceBase[u]){var p=l.innerHTML.match(/.*?([\d,]+\.?\d*)/);this.productPriceBase[u]=p?parseFloat(p[1].replace(/,/g,"")):0}productConfigure.setConfirmCallback(c,function(){var t=productConfigure.getCurrentConfirmedQtyElement();a&&t&&!isNaN(t.value)&&(a.value=t.value);var i=parseFloat(this._calcProductPrice()+this.productPriceBase[u]);l.innerHTML=this.currencySymbol+i.toFixed(2),e.setCheckboxChecked(o,!0)}.bind(this)),productConfigure.setCancelCallback(c,function(){$(productConfigure.confirmedCurrentId)&&$(productConfigure.confirmedCurrentId).innerHTML||e.setCheckboxChecked(o,!1)}),productConfigure.setShowWindowCallback(c,function(){var e=productConfigure.getCurrentFormQtyElement();e&&a&&!isNaN(a.value)&&(e.value=a.value)}.bind(this)),productConfigure.showItemConfiguration(c,u)}}},_calcProductPrice:function(){var e=0,t=function(e){for(var t=0,i=function(e){var t=1;if(e.hasAttribute("qtyId")){if(!$(e.getAttribute("qtyId")).value)return 0;t=parseFloat($(e.getAttribute("qtyId")).value)}return e.hasAttribute("price")&&!e.disabled?parseFloat(e.readAttribute("price"))*t:0},a=0;a<e.length;a++)if("select-one"==e[a].type||"select-multiple"==e[a].type)for(var s=0;s<e[a].options.length;s++)e[a].options[s].selected&&(t+=i(e[a].options[s]));else(("checkbox"==e[a].type||"radio"==e[a].type)&&e[a].checked||("file"==e[a].type||"text"==e[a].type||"textarea"==e[a].type||"hidden"==e[a].type)&&Form.Element.getValue(e[a]))&&(t+=i(e[a]));return t}.bind(this);return e+=t($(productConfigure.confirmedCurrentId).getElementsByTagName("input")),e+=t($(productConfigure.confirmedCurrentId).getElementsByTagName("select")),e+=t($(productConfigure.confirmedCurrentId).getElementsByTagName("textarea"))},productGridCheckboxCheck:function(e,t,i){if(i){if(t.inputElements){this.gridProducts.set(t.value,{});for(var a=this.gridProducts.get(t.value),s=0;s<t.inputElements.length;s++){var n=t.inputElements[s];n.hasClassName("input-inactive")||(n.disabled=!1,"qty"!=n.name||n.value||(n.value=1)),n.checked||"giftmessage"!=n.name?a[n.name]=n.value:a[n.name]&&delete a[n.name]}}}else{if(t.inputElements)for(var s=0;s<t.inputElements.length;s++)t.inputElements[s].disabled=!0;this.gridProducts.unset(t.value)}e.reloadParams={"products[]":this.gridProducts.keys()}},productGridAddSelected:function(){this.productGridShowButton&&Element.show(this.productGridShowButton);var e=["search","items","shipping_method","totals","giftmessage","billing_method"],t={},i=[],a=this.gridProducts.toObject();for(var s in a){i.push(s);var n="item["+s+"]";for(var r in a[s])n+="["+r+"]",t[n]=a[s][r]}this.productConfigureSubmit("product_to_add",e,t,i),productConfigure.clean("quote_items"),this.hideArea("search"),this.gridProducts=$H({})},selectCustomer:function(e,t){var i=Event.findElement(t,"tr");i.title&&this.setCustomerId(i.title)},customerSelectorHide:function(){this.hideArea("customer-selector")},customerSelectorShow:function(){this.showArea("customer-selector")},storeSelectorHide:function(){this.hideArea("store-selector")},storeSelectorShow:function(){this.showArea("store-selector")},dataHide:function(){this.hideArea("data")},dataShow:function(){$("submit_order_top_button")&&$("submit_order_top_button").show(),this.showArea("data")},clearShoppingCart:function(e){confirm(e)&&(this.collectElementsValue=!1,order.sidebarApplyChanges({"sidebar[empty_customer_cart]":1}))},sidebarApplyChanges:function(e){if($(this.getAreaId("sidebar"))){var t={};if(this.collectElementsValue)for(var i=$(this.getAreaId("sidebar")).select("input"),a=0;a<i.length;a++)i[a].getValue()&&(t[i[a].name]=i[a].getValue());if(e instanceof Object)for(var s in e)t[s]=String(e[s]);t.reset_shipping=!0,this.loadArea(["sidebar","items","shipping_method","billing_method","totals","giftmessage"],!0,t)}},sidebarHide:function(){this.storeId===!1&&$("page:left")&&$("page:container")&&($("page:left").hide(),$("page:container").removeClassName("container"),$("page:container").addClassName("container-collapsed"))},sidebarShow:function(){$("page:left")&&$("page:container")&&($("page:left").show(),$("page:container").removeClassName("container-collapsed"),$("page:container").addClassName("container"))},sidebarConfigureProduct:function(e,t,i){var a={};a.reset_shipping=!0,a.add_product=t,this.prepareParams(a);for(var s in a)null===a[s]?unset(a[s]):"boolean"==typeof a[s]&&(a[s]=a[s]?1:0);var n=[];for(var r in a)n.push(new Element("input",{type:"hidden",name:r,value:a[r]}));return productConfigure.setBeforeSubmitCallback(e,function(){productConfigure.addFields(n)}.bind(this)),productConfigure.setOnLoadIFrameCallback(e,function(e){e.ok&&this.loadArea(["items","shipping_method","billing_method","totals","giftmessage"],!0)}.bind(this)),i=i?i:t,productConfigure.showItemConfiguration(e,i),!1},removeSidebarItem:function(e,t){this.loadArea(["sidebar_"+t],"sidebar_data_"+t,{remove_item:e,from:t})},itemsUpdate:function(){for(var e=["sidebar","items","shipping_method","billing_method","totals","giftmessage"],t={update_items:1},i=$("order-items_grid").select("input","select","textarea"),a=0;a<i.length;a++)i[a].disabled||"checkbox"==i[a].type&&!i[a].checked||(t[i[a].name]=i[a].getValue());t=Object.extend(t,this.productConfigureAddFields),this.productConfigureSubmit("quote_items",e,t),this.orderItemChanged=!1},itemsOnchangeBind:function(){for(var e=$("order-items_grid").select("input","select","textarea"),t=0;t<e.length;t++)e[t].bindOnchange||(e[t].bindOnchange=!0,e[t].observe("change",this.itemChange.bind(this)))},itemChange:function(e){this.giftmessageOnItemChange(e),this.orderItemChanged=!0},productConfigureSubmit:function(e,t,i,a){t=this.prepareArea(t),this.loadingAreas=t;var s=this.loadBaseUrl+"block/"+t+"?isAjax=true";i=this.prepareParams(i),i.reset_shipping=1,i.json=1;var n=[];for(var r in i)n.push(new Element("input",{type:"hidden",name:r,value:i[r]}));productConfigure.addFields(n),a&&productConfigure.addItemsFilter(e,a),productConfigure.addListType(e,{urlSubmit:s}),productConfigure.setOnLoadIFrameCallback(e,function(e){this.loadAreaResponseHandler(e)}.bind(this)),productConfigure.submit(e),this.productConfigureAddFields={}},showQuoteItemConfiguration:function(e){var t="quote_items",i=$("order-items_grid").select('input[name="item['+e+'][qty]"]')[0];productConfigure.setConfirmCallback(t,function(){var t=productConfigure.getCurrentConfirmedQtyElement();i&&t&&!isNaN(t.value)&&(i.value=t.value),this.productConfigureAddFields["item["+e+"][configured]"]=1}.bind(this)),productConfigure.setShowWindowCallback(t,function(){var e=productConfigure.getCurrentFormQtyElement();e&&i&&!isNaN(i.value)&&(e.value=i.value)}.bind(this)),productConfigure.showItemConfiguration(t,e)},accountFieldsBind:function(e){if($(e))for(var t=$(e).select("input","select","textarea"),i=0;i<t.length;i++)"group_id"==t[i].id?t[i].observe("change",this.accountGroupChange.bind(this)):t[i].observe("change",this.accountFieldChange.bind(this))},accountGroupChange:function(){this.loadArea(["data"],!0,this.serializeData("order-form_account").toObject())},accountFieldChange:function(){this.saveData(this.serializeData("order-form_account"))},commentFieldsBind:function(e){if($(e))for(var t=$(e).select("input","textarea"),i=0;i<t.length;i++)t[i].observe("change",this.commentFieldChange.bind(this))},commentFieldChange:function(){this.saveData(this.serializeData("order-comment"))},giftmessageFieldsBind:function(e){if($(e))for(var t=$(e).select("input","textarea"),i=0;i<t.length;i++)t[i].observe("change",this.giftmessageFieldChange.bind(this))},giftmessageFieldChange:function(){this.giftMessageDataChanged=!0},giftmessageOnItemChange:function(e){var t=Event.element(e);if(-1!=t.name.indexOf("giftmessage")&&"checkbox"==t.type&&!t.checked)for(var i,a=$("order-giftmessage").select("textarea"),s=0;s<a.length;s++)i=a[s].id.split("_"),i.length<2||-1!=t.name.indexOf("["+i[1]+"]")&&""!=a[s].value&&(alert("First, clean the Message field in Gift Message form"),t.checked=!0)},loadArea:function(e,t,i){var a=this.loadBaseUrl;e&&(e=this.prepareArea(e),a+="block/"+e),t===!0&&(t="html-body"),i=this.prepareParams(i),i.json=!0,this.loadingAreas||(this.loadingAreas=[]),t?(this.loadingAreas=e,new Ajax.Request(a,{parameters:i,loaderArea:t,onSuccess:function(e){var t=e.responseText.evalJSON();this.loadAreaResponseHandler(t)}.bind(this)})):new Ajax.Request(a,{parameters:i,loaderArea:t}),"undefined"!=typeof productConfigure&&e instanceof Array&&-1!=e.indexOf("items")&&productConfigure.clean("quote_items")},loadAreaResponseHandler:function(e){e.error&&alert(e.message),e.ajaxExpired&&e.ajaxRedirect&&setLocation(e.ajaxRedirect),this.loadingAreas||(this.loadingAreas=[]),"string"==typeof this.loadingAreas&&(this.loadingAreas=[this.loadingAreas]),-1==this.loadingAreas.indexOf("message")&&this.loadingAreas.push("message");for(var t=0;t<this.loadingAreas.length;t++){var i=this.loadingAreas[t];if($(this.getAreaId(i))){if("message"!=i||e[i]){var a=new Element("div");a.update(e[i]?e[i]:""),$(this.getAreaId(i)).update(Prototype.Browser.IE?a.outerHTML:a)}$(this.getAreaId(i)).callback&&this[$(this.getAreaId(i)).callback]()}}},prepareArea:function(e){return this.giftMessageDataChanged?e.without("giftmessage"):e},saveData:function(e){this.loadArea(!1,!1,e)},showArea:function(e){var t=this.getAreaId(e);$(t)&&($(t).show(),this.areaOverlay())},hideArea:function(e){var t=this.getAreaId(e);$(t)&&($(t).hide(),this.areaOverlay())},areaOverlay:function(){$H(order.overlayData).each(function(e){e.value.fx()})},getAreaId:function(e){return"order-"+e},prepareParams:function(e){e||(e={}),e.customer_id||(e.customer_id=this.customerId),e.store_id||(e.store_id=this.storeId),e.currency_id||(e.currency_id=this.currencyId),e.form_key||(e.form_key=FORM_KEY);var t=this.serializeData("order-billing_method");return t&&t.each(function(t){e[t[0]]=t[1]}),e},serializeData:function(e){var t=$(e).select("input","select","textarea"),i=Form.serializeElements(t,!0);return $H(i)},toggleCustomPrice:function(e,t,i){e.checked?($(t).disabled=!1,$(t).show(),$(i)&&$(i).hide()):($(t).disabled=!0,$(t).hide(),$(i)&&$(i).show())},submit:function(){this.orderItemChanged?confirm("You have item changes")?editForm.submit()&&disableElements("save"):this.itemsUpdate():editForm.submit()&&disableElements("save")},overlay:function(e,t){"undefined"==typeof t&&(t=!0);var i=this,a=this.overlayData.get(e);a?(a.show=t,Event.stopObserving(window,"resize",a.bfx)):(a={show:t,el:e,order:i,fx:function(){this.order.processOverlay(this.el,this.show)}},a.bfx=a.fx.bindAsEventListener(a),this.overlayData.set(e,a)),Event.observe(window,"resize",a.bfx),this.processOverlay(e,t)},processOverlay:function(e,t){var i=$(e);if(!i)return!1;var a=i.up(1);t?a.removeClassName("ignore-validate"):a.addClassName("ignore-validate"),Prototype.Browser.IE&&a.select("select").each(function(e){t?(e.needShowOnSuccess=!1,e.style.visibility=""):(e.style.visibility="hidden",e.needShowOnSuccess=!0)}),a.setStyle({position:"relative"}),i.setStyle({display:t?"none":"",position:"absolute",backgroundColor:"#999999",opacity:.8,width:a.getWidth()+"px",height:a.getHeight()+"px",top:0,left:0})},validateVat:function(e){var t={country:$(e.countryElementId).value,vat:$(e.vatElementId).value};this.storeId!==!1&&(t.store_id=this.storeId);var i=$(e.groupIdHtmlId).value;new Ajax.Request(e.validateUrl,{parameters:t,onSuccess:function(a){var s="",n=!1;try{a=a.responseText.evalJSON(),!0===a.valid?(s=e.vatValidMessage,i!=a.group&&(s=e.vatValidAndGroupChangeMessage,n=!0)):a.success?(s=e.vatInvalidMessage.replace(/%s/,t.vat),n=!0):(s=e.vatValidationFailedMessage,n=!0)}catch(r){s=e.vatErrorMessage}n?this.processCustomerGroupChange(e.groupIdHtmlId,s,a.group):alert(s)}.bind(this)})},processCustomerGroupChange:function(e,t,i){var a=$(e).value,s=$$("#"+e+" > option[value="+a+"]")[0].text,n=$$("#"+e+" > option[value="+i+"]")[0],r=t.replace(/%s/,n.text);r=r.replace(/%s/,s),confirm(r)&&($$("#"+e+" option").each(function(e){e.selected=e.readAttribute("value")==i}),this.accountGroupChange())}};var OrderFormArea=Class.create();OrderFormArea.prototype={_name:null,_node:null,_parent:null,_callbackName:null,initialize:function(e,t,i){this._name=e,this._parent=i,this._callbackName=t.callback,"undefined"==typeof this._callbackName&&(this._callbackName=e+"Loaded",t.callback=this._callbackName),i[this._callbackName]=i[this._callbackName].wrap(function(e){e(),this.onLoad()}.bind(this)),this.setNode(t)},setNode:function(e){e.callback||(e.callback=this._callbackName),this.node=e},onLoad:function(){}};var ControlButton=Class.create();ControlButton.prototype={_label:"",_node:null,initialize:function(e){this._label=e,this._node=new Element("button",{"class":"scalable add",type:"button"})},onClick:function(){},insertIn:function(e,t){var i=Object.extend(this._node),a={};i.observe("click",this.onClick),i.update("<span>"+this._label+"</span>"),a[t]=i,Element.insert(e,a)}};