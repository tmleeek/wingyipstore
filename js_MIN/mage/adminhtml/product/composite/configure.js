ProductConfigure=Class.create(),ProductConfigure.prototype={listTypes:$H({}),current:$H({}),itemsFilter:$H({}),blockWindow:null,blockForm:null,blockFormFields:null,blockFormAdd:null,blockFormConfirmed:null,blockConfirmed:null,blockIFrame:null,blockCancelBtn:null,blockMask:null,blockMsg:null,blockMsgError:null,windowHeight:null,confirmedCurrentId:null,confirmCallback:{},cancelCallback:{},onLoadIFrameCallback:{},showWindowCallback:{},beforeSubmitCallback:{},iFrameJSVarname:null,_listTypeId:1,initialize:function(){this._initWindowElements()},_initWindowElements:function(){this.blockWindow=$("product_composite_configure"),this.blockForm=$("product_composite_configure_form"),this.blockFormFields=$("product_composite_configure_form_fields"),this.blockFormAdd=$("product_composite_configure_form_additional"),this.blockFormConfirmed=$("product_composite_configure_form_confirmed"),this.blockConfirmed=$("product_composite_configure_confirmed"),this.blockIFrame=$("product_composite_configure_iframe"),this.blockCancelBtn=$("product_composite_configure_form_cancel"),this.blockMask=$("popup-window-mask"),this.blockMsg=$("product_composite_configure_messages"),this.blockMsgError=this.blockMsg.select(".error-msg")[0],this.windowHeight=$("html-body").getHeight(),this.iFrameJSVarname=this.blockForm.select('input[name="as_js_varname"]')[0].value},_generateListTypeId:function(){return"_internal_lt_"+this._listTypeId++},addListType:function(e,t){return"undefined"==typeof this.listTypes[e]&&(this.listTypes[e]={}),Object.extend(this.listTypes[e],t),this},addComplexListType:function(e,t){var i=this._generateListTypeId();return this.listTypes[i]={},this.listTypes[i].complexTypes=e,this.listTypes[i].urlSubmit=t,i},addItemsFilter:function(e,t){return e&&t?("undefined"==typeof this.itemsFilter[e]&&(this.itemsFilter[e]=[]),this.itemsFilter[e]=this.itemsFilter[e].concat(t),this):!1},_getConfirmedBlockId:function(e,t){return this.blockConfirmed.id+"["+e+"]["+t+"]"},itemConfigured:function(e,t){var i=this._getConfirmedBlockId(e,t),s=$(i);return!(!s||!s.innerHTML)},showItemConfiguration:function(e,t){return e&&t?(this._initWindowElements(),this.current.listType=e,this.current.itemId=t,this.confirmedCurrentId=this._getConfirmedBlockId(e,t),void(this.itemConfigured(e,t)?(this._processFieldsData("item_restore"),this._showWindow()):this._requestItemConfiguration(e,t))):!1},_requestItemConfiguration:function(e,t){if(!this.listTypes[e].urlFetch)return!1;var i=this.listTypes[e].urlFetch;i&&new Ajax.Request(i,{parameters:{id:t},onSuccess:function(t){var i=t.responseText;if(i.isJSON())i=i.evalJSON(),i.error&&(this.blockMsg.show(),this.blockMsgError.innerHTML=i.message,this.blockCancelBtn.hide(),this.setConfirmCallback(e,null),this._showWindow());else if(i){i+="",this.blockFormFields.update(i);var s={},n=i.extractScripts();s.scripts=n;var r=new Element("div",{style:"display:none"});r.mageData=s,this.blockFormFields.insert(r),this._showWindow()}}.bind(this)})},onConfirmBtn:function(){return productCompositeConfigureForm.validate()&&(this.listTypes[this.current.listType].urlConfirm?this.submit():(this._processFieldsData("item_confirm"),this._closeWindow(),Object.isFunction(this.confirmCallback[this.current.listType])&&this.confirmCallback[this.current.listType]())),this},onCancelBtn:function(){return this._closeWindow(),Object.isFunction(this.cancelCallback[this.current.listType])&&this.cancelCallback[this.current.listType](),this},submit:function(e){e&&(this.current.listType=e,this.current.itemId=null);var t=this.listTypes[this.current.listType].urlConfirm,i=this.listTypes[this.current.listType].urlSubmit;if(!t&&!i)return!1;if(t)this.blockForm.action=t,this.addFields([new Element("input",{type:"hidden",name:"id",value:this.current.itemId})]);else{this.blockForm.action=i;var s=this.listTypes[this.current.listType].complexTypes;s&&this.addFields([new Element("input",{type:"hidden",name:"configure_complex_list_types",value:s.join(",")})]),this._processFieldsData("current_confirmed_to_form");for(var n=["input","select","textarea"],r={},o=0,l=n.length;l>o;o++)for(var c=n[o],a=this.blockFormAdd.getElementsByTagName(c),m=0,d=a.length;d>m;m++)r[a[m].name]=!0;for(var o=0,l=n.length;l>o;o++)for(var c=n[o],a=this.blockFormConfirmed.getElementsByTagName(c),m=0,d=a.length;d>m;m++){var h=a[m];r[h.name]?(h.setAttribute("configure_disabled",1),h.setAttribute("configure_prev_disabled",h.disabled?1:0),h.disabled=!0):h.setAttribute("configure_disabled",0)}}return Object.isFunction(this.beforeSubmitCallback[this.current.listType])&&this.beforeSubmitCallback[this.current.listType](),this.blockForm.submit(),varienLoaderHandler.handler.onCreate({options:{loaderArea:!0}}),this},addFields:function(e){return e.each(function(e){this.blockFormAdd.insert(e)}.bind(this)),this},onLoadIFrame:function(){this.blockFormConfirmed.select("[configure_disabled=1]").each(function(e){e.disabled="1"==e.getAttribute("configure_prev_disabled")}),this._processFieldsData("form_confirmed_to_confirmed");var e=this.blockIFrame.contentWindow[this.iFrameJSVarname];if(e&&"object"==typeof e){if(this.listTypes[this.current.listType].urlConfirm)if(e.ok)this._closeWindow(),this.clean("current");else if(e.error)return this.showItemConfiguration(this.current.listType,this.current.itemId),this.blockMsg.show(),this.blockMsgError.innerHTML=e.message,this._showWindow(),!1;Object.isFunction(this.onLoadIFrameCallback[this.current.listType])&&this.onLoadIFrameCallback[this.current.listType](e),document.fire(this.current.listType+":afterIFrameLoaded")}varienLoaderHandler.handler.onComplete(),this.clean("current")},_getIFrameContent:function(){var e=this.blockIFrame.contentWindow||this.blockIFrame.contentDocument;return e.document&&(e=e.document),e},getCurrentConfirmedQtyElement:function(){for(var e=$(this.confirmedCurrentId).getElementsByTagName("input"),t=0;t<e.length;t++)if("qty"==e[t].name)return e[t]},getCurrentFormQtyElement:function(){for(var e=this.blockFormFields.getElementsByTagName("input"),t=0;t<e.length;t++)if("qty"==e[t].name)return e[t]},_showWindow:function(){this._toggleSelectsExceptBlock(!1),this.blockMask.setStyle({height:this.windowHeight+"px"}).show(),this.blockWindow.setStyle({marginTop:-this.blockWindow.getHeight()/2+"px",display:"block"}),Object.isFunction(this.showWindowCallback[this.current.listType])&&this.showWindowCallback[this.current.listType]()},_toggleSelectsExceptBlock:function(e){if(Prototype.Browser.IE){if(this.blockForm)for(var t=new Array,i=this.blockForm.getElementsByTagName("select"),s=0;s<i.length;s++)t[s]=i[s].style.visibility;if(toggleSelectsUnderBlock(this.blockMask,e),this.blockForm)for(s=0;s<i.length;s++)i[s].style.visibility=t[s]}},_closeWindow:function(){toggleSelectsUnderBlock(this.blockMask,!0),this.blockMask.style.display="none",this.blockWindow.style.display="none",this.clean("window")},setConfirmCallback:function(e,t){return this.confirmCallback[e]=t,this},setCancelCallback:function(e,t){return this.cancelCallback[e]=t,this},setOnLoadIFrameCallback:function(e,t){return this.onLoadIFrameCallback[e]=t,this},setShowWindowCallback:function(e,t){return this.showWindowCallback[e]=t,this},setBeforeSubmitCallback:function(e,t){return this.beforeSubmitCallback[e]=t,this},clean:function(e){var t=null,i=null,s=function(e){this.blockConfirmed.childElements().each(function(t){for(var i=0,s=e.length;s>i;i++){var n=this.blockConfirmed.id+"["+e[i]+"]";if(0==t.id.indexOf(n)){t.remove();break}}}.bind(this))}.bind(this);switch(e){case"current":t=this.listTypes[this.current.listType],i=[this.current.listType],t.complexTypes&&(i=i.concat(t.complexTypes)),s(i);break;case"window":this.blockFormFields.update(),this.blockMsg.hide(),this.blockMsgError.update(),this.blockCancelBtn.show();break;default:this.listTypes[e]?(t=this.listTypes[e],i=[e],t.complexTypes&&(i=i.concat(t.complexTypes)),s(i)):e||(this.current=$H({}),this.blockConfirmed.update(),this.blockFormFields.update(),this.blockMsg.hide(),this.blockMsgError.update(),this.blockCancelBtn.show())}return this._getIFrameContent().body.innerHTML="",this.blockIFrame.contentWindow[this.iFrameJSVarname]={},this.blockFormAdd.update(),this.blockFormConfirmed.update(),this.blockForm.action="",this},_processFieldsData:function(method){var _renameFields=function(e,t,i){var s=null,n=null,r=null,o=null,l=t.id.match(/.*\[\w+\]\[([^\]]+)\]$/),c=l[1];if("current_confirmed_to_form"==e)s=RegExp("(\\w+)(\\[?)"),n=RegExp("(\\w+)"),r="item["+c+"][$1]$2",o="item_"+c+"_$1",i&&(r="list["+i+"][item]["+c+"][$1]$2",o="list_"+i+"_"+o);else{if("form_confirmed_to_confirmed"!=e)return!1;var a="item\\["+c+"\\]\\[(\\w+)\\](.*)",m="item_"+c+"_(\\w+)";i&&(a="list\\["+i+"\\]\\[item\\]\\["+c+"\\]\\[(\\w+)\\](.*)",m="list_"+i+"_"+m),s=new RegExp(a),n=new RegExp(m),r="$1$2",o="$1"}var d=function(e){for(var t=0;t<e.length;t++)e[t].name&&"file"==e[t].type?e[t].name=e[t].name.replace(n,o):e[t].name&&(e[t].name=e[t].name.replace(s,r))};d(t.getElementsByTagName("input")),d(t.getElementsByTagName("select")),d(t.getElementsByTagName("textarea"))}.bind(this);switch(method){case"item_confirm":$(this.confirmedCurrentId)?$(this.confirmedCurrentId).update():this.blockConfirmed.insert(new Element("div",{id:this.confirmedCurrentId})),this.blockFormFields.childElements().each(function(e){$(this.confirmedCurrentId).insert(e)}.bind(this));break;case"item_restore":this.blockFormFields.update();var mageData=null;$(this.confirmedCurrentId).childElements().each(function(e){var t=e.cloneNode(!0);e.mageData&&(t.mageData=e.mageData,mageData=e.mageData),this.blockFormFields.insert(t)}.bind(this));var fieldsValue={},getConfirmedValues=function(e){for(var t=0;t<e.length;t++)e[t].name&&("undefined"==typeof fieldsValue[e[t].name]&&(fieldsValue[e[t].name]={}),"checkbox"==e[t].type?fieldsValue[e[t].name][e[t].value]=e[t].checked:"radio"==e[t].type?e[t].checked&&(fieldsValue[e[t].name]=e[t].value):fieldsValue[e[t].name]=Form.Element.getValue(e[t]))}.bind(this);getConfirmedValues($(this.confirmedCurrentId).getElementsByTagName("input")),getConfirmedValues($(this.confirmedCurrentId).getElementsByTagName("select")),getConfirmedValues($(this.confirmedCurrentId).getElementsByTagName("textarea"));var restoreConfirmedValues=function(e){for(var t=0;t<e.length;t++)"undefined"!=typeof fieldsValue[e[t].name]&&"file"!=e[t].type&&("checkbox"==e[t].type?e[t].checked=fieldsValue[e[t].name][e[t].value]:"radio"==e[t].type?e[t].value==fieldsValue[e[t].name]&&(e[t].checked=!0):e[t].setValue(fieldsValue[e[t].name]))}.bind(this);if(restoreConfirmedValues(this.blockFormFields.getElementsByTagName("input")),restoreConfirmedValues(this.blockFormFields.getElementsByTagName("select")),restoreConfirmedValues(this.blockFormFields.getElementsByTagName("textarea")),mageData&&mageData.scripts){this.restorePhase=!0;try{mageData.scripts.map(function(script){return eval(script)})}catch(e){}this.restorePhase=!1}break;case"current_confirmed_to_form":var allowedListTypes={};allowedListTypes[this.current.listType]=!0;var listInfo=this.listTypes[this.current.listType];if(listInfo.complexTypes)for(var i=0,len=listInfo.complexTypes.length;len>i;i++)allowedListTypes[listInfo.complexTypes[i]]=!0;this.blockFormConfirmed.update(),this.blockConfirmed.childElements().each(function(e){var t=e.id.match(/.*\[(\w+)\]\[([^\]]+)\]$/),i=t[1],s=t[2];!allowedListTypes[i]||this.itemsFilter[i]&&-1==this.itemsFilter[i].indexOf(s)||(_renameFields(method,e,listInfo.complexTypes?i:null),this.blockFormConfirmed.insert(e))}.bind(this));break;case"form_confirmed_to_confirmed":var listInfo=this.listTypes[this.current.listType];this.blockFormConfirmed.childElements().each(function(e){var t=e.id.match(/.*\[(\w+)\]\[([^\]]+)\]$/),i=t[1];_renameFields(method,e,listInfo.complexTypes?i:null),this.blockConfirmed.insert(e)}.bind(this))}},changeOptionQty:function(e,t){var i=!0;"undefined"!=typeof t&&(8==t.keyCode||46==t.keyCode)&&(i=!1),i&&(Number(e.value)<=0||isNaN(Number(e.value)))&&(e.value=1)}},Event.observe(window,"load",function(){productConfigure=new ProductConfigure});