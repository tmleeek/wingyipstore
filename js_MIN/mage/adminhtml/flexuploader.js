window.Flex?(Flex.Uploader=Class.create(),Flex.Uploader.prototype={flex:null,uploader:null,filters:null,containerId:null,flexContainerId:null,container:null,files:null,fileRowTemplate:null,fileProgressTemplate:null,templatesPattern:/(^|.|\r|\n)(\{\{(.*?)\}\})/,onFilesComplete:!1,onFileProgress:!0,onFileRemove:!1,onContainerHideBefore:null,initialize:function(e,t,i){this.containerId=e,this.container=$(e),this.container.controller=this,this.config=i,this.flexContainerId=this.containerId+"-flash",Element.insert(this.containerId,{before:'<div id="'+this.flexContainerId+'" class="flex" style="position:relative;float:right;"></div>'}),flexWidth=230,this.config.width&&(flexWidth=this.config.width),this.flex=new Flex.Object({left:100,top:300,width:flexWidth,height:20,src:t,wmode:"transparent"}),this.fileRowTemplate=new Template(this.getInnerElement("template").innerHTML,this.templatesPattern),this.fileProgressTemplate=new Template(this.getInnerElement("template-progress").innerHTML,this.templatesPattern),this.flex.onBridgeInit=this.handleBridgeInit.bind(this),this.flex.detectFlashVersion(9,0,28)?this.flex.apply(this.flexContainerId):this.getInnerElement("install-flash").show(),this.onContainerHideBefore=this.handleContainerHideBefore.bind(this)},getInnerElement:function(e){return $(this.containerId+"-"+e)},getFileId:function(e){var t;return t="object"==typeof e?e.id:e,this.containerId+"-file-"+t},getDeleteButton:function(e){return $(this.getFileId(e)+"-delete")},handleBridgeInit:function(){this.uploader=this.flex.getBridge().getUpload(),this.config.filters&&($H(this.config.filters).each(function(e){this.uploader.addTypeFilter(e.key,e.value.label,e.value.files)}.bind(this)),delete this.config.filters,this.uploader.setUseTypeFilter(!0)),this.uploader.setConfig(this.config),this.uploader.addEventListener("select",this.handleSelect.bind(this)),this.uploader.addEventListener("complete",this.handleComplete.bind(this)),this.uploader.addEventListener("progress",this.handleProgress.bind(this)),this.uploader.addEventListener("error",this.handleError.bind(this)),this.uploader.addEventListener("removeall",this.handleRemoveAll.bind(this))},browse:function(){this.uploader.browse()},upload:function(){this.uploader.upload(),this.files=this.uploader.getFilesInfo(),this.updateFiles()},removeFile:function(e){this.uploader.removeFile(e),$(this.getFileId(e)).remove(),this.onFileRemove&&this.onFileRemove(e),this.files=this.uploader.getFilesInfo(),this.updateFiles()},removeAllFiles:function(){this.files.each(function(e){this.removeFile(e.id)}.bind(this)),this.files=this.uploader.getFilesInfo(),this.updateFiles()},handleSelect:function(e){this.files=e.getData().files,this.checkFileSize(),this.updateFiles(),this.getInnerElement("upload").show(),this.onFileSelect&&this.onFileSelect()},handleProgress:function(e){var t=e.getData().file;this.updateFile(t),this.onFileProgress&&this.onFileProgress(t)},handleError:function(e){this.updateFile(e.getData().file)},handleComplete:function(e){this.files=e.getData().files,this.updateFiles(),this.onFilesComplete&&this.onFilesComplete(this.files)},handleRemoveAll:function(){this.files.each(function(e){$(this.getFileId(e.id)).remove()}.bind(this)),this.onFileRemoveAll&&this.onFileRemoveAll(),this.files=this.uploader.getFilesInfo(),this.updateFiles()},handleRemove:function(){this.files=this.uploader.getFilesInfo(),this.updateFiles()},updateFiles:function(){this.files.each(function(e){this.updateFile(e)}.bind(this))},updateFile:function(e){if($(this.getFileId(e))||(this.config.replace_browse_with_remove?($(this.containerId+"-new").show(),$(this.containerId+"-new").innerHTML=this.fileRowTemplate.evaluate(this.getFileVars(e)),$(this.containerId+"-old").hide(),this.flex.getBridge().hideBrowseButton()):Element.insert(this.container,{bottom:this.fileRowTemplate.evaluate(this.getFileVars(e))})),"full_complete"==e.status&&e.response.isJSON()){var t=e.response.evalJSON();if("object"==typeof t){if("object"==typeof t.cookie){var i=new Date;i.setTime(i.getTime()+1e3*parseInt(t.cookie.lifetime)),document.cookie=escape(t.cookie.name)+"="+escape(t.cookie.value)+"; expires="+i.toGMTString()+(t.cookie.path.blank()?"":"; path="+t.cookie.path)+(t.cookie.domain.blank()?"":"; domain="+t.cookie.domain)}"undefined"!=typeof t.error&&0!=t.error&&(e.status="error",e.errorText=t.error)}}"full_complete"!=e.status||e.response.isJSON()||(e.status="error");var s=$(this.getFileId(e)).getElementsByClassName("progress-text")[0];if("progress"==e.status||"complete"==e.status)$(this.getFileId(e)).addClassName("progress"),$(this.getFileId(e)).removeClassName("new"),$(this.getFileId(e)).removeClassName("error"),s.update(e.progress&&e.progress.total?this.fileProgressTemplate.evaluate(this.getFileProgressVars(e)):""),this.config.replace_browse_with_remove||this.getDeleteButton(e).hide();else if("error"==e.status){$(this.getFileId(e)).addClassName("error"),$(this.getFileId(e)).removeClassName("progress"),$(this.getFileId(e)).removeClassName("new");var l=e.errorText?e.errorText:this.errorText(e);this.config.replace_browse_with_remove?this.flex.getBridge().hideBrowseButton():this.getDeleteButton(e).show(),s.update(l)}else"full_complete"==e.status&&($(this.getFileId(e)).addClassName("complete"),$(this.getFileId(e)).removeClassName("progress"),$(this.getFileId(e)).removeClassName("error"),this.config.replace_browse_with_remove&&this.flex.getBridge().hideRemoveButton(),s.update(this.translate("Complete")))},getDebugStr:function(e){return Object.toJSON(e).replace("&","&amp;").replace(">","&gt;").replace("<","&lt;")},getFileVars:function(e){return{id:this.getFileId(e),fileId:e.id,name:e.name,size:this.formatSize(e.size)}},getFileProgressVars:function(e){return{total:this.formatSize(e.progress.total),uploaded:this.formatSize(e.progress.loaded),percent:this.round(e.progress.loaded/e.progress.total*100)}},formatSize:function(e){return e>1099511627776?this.round(e/1099511627776)+" "+this.translate("TB"):e>1073741824?this.round(e/1073741824)+" "+this.translate("GB"):e>1048576?this.round(e/1048576)+" "+this.translate("MB"):e>1024?this.round(e/1024)+" "+this.translate("kB"):e+" "+this.translate("B")},round:function(e){return Math.round(100*e)/100},checkFileSize:function(){newFiles=[],hasTooBigFiles=!1,this.files.each(function(e){e.size>maxUploadFileSizeInBytes?(hasTooBigFiles=!0,this.uploader.removeFile(e.id)):newFiles.push(e)}.bind(this)),this.files=newFiles,hasTooBigFiles&&alert(this.translate("Maximum allowed file size for upload is")+" "+maxUploadFileSize+".\n"+this.translate("Please check your server PHP settings."))},translate:function(e){try{if(Translator)return Translator.translate(e)}catch(t){}return e},errorText:function(e){var t="";switch(e.errorCode){case 1:t="File size should be more than 0 bytes";break;case 2:t="Upload HTTP Error";break;case 3:t="Upload I/O Error";break;case 4:t="Upload Security Error";break;case 5:t="SSL Error: Invalid or self-signed certificate"}return t?this.translate(t):t},handleContainerHideBefore:function(e){if(e&&Element.descendantOf(this.container,e)&&!this.checkAllComplete()){if(!confirm("There are files that were selected but not uploaded yet. After switching to another tab your selections will be lost. Do you wish to continue ?"))return"cannotchange";this.removeAllFiles()}},checkAllComplete:function(){return this.files?!this.files.any(function(e){return"full_complete"!==e.status}):!0}}):alert("Flex library not loaded");