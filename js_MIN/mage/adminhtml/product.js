function toogleFieldEditMode(e,t){$(e).checked?enableFieldEditMode(t):disableFieldEditMode(t)}function disableFieldEditMode(e){$(e).disabled=!0,$(e+"_hidden")&&($(e+"_hidden").disabled=!0)}function enableFieldEditMode(e){$(e).disabled=!1,$(e+"_hidden")&&($(e+"_hidden").disabled=!1)}function initDisableFields(e){onInitDisableFieldsList.push(e)}function onCompleteDisableInited(){onInitDisableFieldsList.each(function(e){disableFieldEditMode(e)})}function onUrlkeyChanged(e){e=$(e);var t=e.next("input[type=hidden]"),i=e.next("input[type=checkbox]"),a=i.value;i.disabled=a==e.value,t.disabled=i.disabled}function onCustomUseParentChanged(e){var t=1==e.value?!0:!1;e.up(2).select("input","select","textarea").each(function(i){e.id!=i.id&&(i.disabled=t)}),e.up(2).select("img").each(function(e){t?e.hide():e.show()})}var Product={};Product.Gallery=Class.create(),Product.Gallery.prototype={images:[],file2id:{no_selection:0},idIncrement:1,containerId:"",container:null,uploader:null,imageTypes:{},initialize:function(e,t,i){this.containerId=e,this.container=$(this.containerId),this.uploader=t,this.imageTypes=i,this.uploader&&(this.uploader.onFilesComplete=this.handleUploadComplete.bind(this)),this.images=this.getElement("save").value.evalJSON(),this.imagesValues=this.getElement("save_image").value.evalJSON(),this.template=new Template('<tr id="__id__" class="preview">'+this.getElement("template").innerHTML+"</tr>",new RegExp("(^|.|\\r|\\n)(__([a-zA-Z0-9_]+)__)","")),this.fixParentTable(),this.updateImages(),varienGlobalEvents.attachEventHandler("moveTab",this.onImageTabMove.bind(this))},onImageTabMove:function(e){var t=!1;this.container.ancestors().each(function(e){if(e.tabObject)throw t=e.tabObject,$break}.bind(this)),t&&e.tab&&e.tab.name&&t.name==e.tab.name&&(this.container.select('input[type="radio"]').each(function(e){e.observe("change",this.onChangeRadio)}.bind(this)),this.updateImages())},fixParentTable:function(){this.container.ancestors().each(function(e){if("td"==e.tagName.toLowerCase()&&(e.style.width="100%"),"table"==e.tagName.toLowerCase())throw e.style.width="100%",$break})},getElement:function(e){return $(this.containerId+"_"+e)},showUploader:function(){this.getElement("add_images_button").hide(),this.getElement("uploader").show()},handleUploadComplete:function(e){e.each(function(e){if(e.response.isJSON()){var t=e.response.evalJSON();if(!t.error){var i={};i.url=t.url,i.file=t.file,i.label="",i.position=this.getNextPosition(),i.disabled=0,i.removed=0,this.images.push(i),this.uploader.removeFile(e.id)}}else try{console.log(e.response)}catch(a){alert(e.response)}}.bind(this)),this.container.setHasChanges(),this.updateImages()},updateImages:function(){this.getElement("save").value=Object.toJSON(this.images),$H(this.imageTypes).each(function(e){this.getFileElement("no_selection","cell-"+e.key+" input").checked=!0}.bind(this)),this.images.each(function(e){$(this.prepareId(e.file))||this.createImageRow(e),this.updateVisualisation(e.file)}.bind(this)),this.updateUseDefault(!1)},onChangeRadio:function(e){var t=Event.element(e);t.setHasChanges()},createImageRow:function(e){var t=Object.clone(e);t.id=this.prepareId(e.file);var i=this.template.evaluate(t);Element.insert(this.getElement("list"),{bottom:i}),$(t.id).select('input[type="radio"]').each(function(e){e.observe("change",this.onChangeRadio)}.bind(this))},prepareId:function(e){return"undefined"==typeof this.file2id[e]&&(this.file2id[e]=this.idIncrement++),this.containerId+"-image-"+this.file2id[e]},getNextPosition:function(){var e=0;return this.images.each(function(t){parseInt(t.position)>e&&(e=parseInt(t.position))}),e+1},updateImage:function(e){var t=this.getIndexByFile(e);this.images[t].label=this.getFileElement(e,"cell-label input").value,this.images[t].position=this.getFileElement(e,"cell-position input").value,this.images[t].removed=this.getFileElement(e,"cell-remove input").checked?1:0,this.images[t].disabled=this.getFileElement(e,"cell-disable input").checked?1:0,this.getElement("save").value=Object.toJSON(this.images),this.updateState(e),this.container.setHasChanges()},loadImage:function(e){var t=this.getImageByFile(e);this.getFileElement(e,"cell-image img").src=t.url,this.getFileElement(e,"cell-image img").show(),this.getFileElement(e,"cell-image .place-holder").hide()},setProductImages:function(e){$H(this.imageTypes).each(function(t){this.getFileElement(e,"cell-"+t.key+" input").checked&&(this.imagesValues[t.key]="no_selection"==e?null:e)}.bind(this)),this.getElement("save_image").value=Object.toJSON($H(this.imagesValues))},updateVisualisation:function(e){var t=this.getImageByFile(e);this.getFileElement(e,"cell-label input").value=t.label,this.getFileElement(e,"cell-position input").value=t.position,this.getFileElement(e,"cell-remove input").checked=1==t.removed,this.getFileElement(e,"cell-disable input").checked=1==t.disabled,$H(this.imageTypes).each(function(t){this.imagesValues[t.key]==e&&(this.getFileElement(e,"cell-"+t.key+" input").checked=!0)}.bind(this)),this.updateState(e)},updateState:function(e){this.getFileElement(e,"cell-position input").disabled=this.getFileElement(e,"cell-disable input").checked?!0:!1},getFileElement:function(e,t){var i="#"+this.prepareId(e)+" ."+t,a=$$(i);if(!a[0])try{console.log(i)}catch(n){alert(i)}return $$("#"+this.prepareId(e)+" ."+t)[0]},getImageByFile:function(e){return null===this.getIndexByFile(e)?!1:this.images[this.getIndexByFile(e)]},getIndexByFile:function(e){var t;return this.images.each(function(i,a){i.file==e&&(t=a)}),t},updateUseDefault:function(){this.getElement("default")&&this.getElement("default").select("input").each(function(e){$(this.containerId).select(".cell-"+e.value+" input").each(function(t){t.disabled=e.checked})}.bind(this)),0==arguments.length&&this.container.setHasChanges()},handleUploadProgress:function(){},handleUploadError:function(){}},Product.AttributesBridge={tabsObject:!1,bindTabs2Attributes:{},bind:function(e,t){this.bindTabs2Attributes[e]=t},getAttributes:function(e){return this.bindTabs2Attributes[e]},setTabsObject:function(e){this.tabsObject=e},getTabsObject:function(){return this.tabsObject},addAttributeRow:function(e){$H(e).each(function(e){this.getTabsObject().activeTab.name!=e.key&&this.getTabsObject().showTabContent($(e.key)),this.getAttributes(e.key).addRow(e.value)}.bind(this))}},Product.Attributes=Class.create(),Product.Attributes.prototype={config:{},containerId:null,initialize:function(e){this.containerId=e},setConfig:function(e){this.config=e,Product.AttributesBridge.bind(this.getConfig().tab_id,this)},getConfig:function(){return this.config},create:function(){var e=window.open(this.getConfig().url,"new_attribute","width=900,height=600,resizable=1,scrollbars=1");e.focus()},addRow:function(e){var t=$$("#group_fields"+this.getConfig().group_id+" .form-list tbody")[0];Element.insert(t,{bottom:e});var i=t.childElements(),a=i[i.size()-1].select("input","select","textarea")[0];a&&window.scrollTo(0,Position.cumulativeOffset(a)[1]+a.offsetHeight)}},Product.Configurable=Class.create(),Product.Configurable.prototype={initialize:function(e,t,i,a,n){this.templatesSyntax=new RegExp("(^|.|\\r|\\n)('{{\\s*(\\w+)\\s*}}')",""),this.attributes=e,this.idPrefix=i,this.links=$H(t),this.newProducts=[],this.readonly=n,this.addAttributeTemplate=new Template($(i+"attribute_template").innerHTML.replace(/__id__/g,"'{{html_id}}'").replace(/ template no-display/g,""),this.templatesSyntax),this.addValueTemplate=new Template($(i+"value_template").innerHTML.replace(/__id__/g,"'{{html_id}}'").replace(/ template no-display/g,""),this.templatesSyntax),this.pricingValueTemplate=new Template($(i+"simple_pricing").innerHTML,this.templatesSyntax),this.pricingValueViewTemplate=new Template($(i+"simple_pricing_view").innerHTML,this.templatesSyntax),this.container=$(i+"attributes"),this.onLabelUpdate=this.updateLabel.bindAsEventListener(this),this.onValuePriceUpdate=this.updateValuePrice.bindAsEventListener(this),this.onValueTypeUpdate=this.updateValueType.bindAsEventListener(this),this.onValueDefaultUpdate=this.updateValueUseDefault.bindAsEventListener(this),this.createAttributes(),this.grid=a,this.grid.rowClickCallback=this.rowClick.bind(this),this.grid.initRowCallback=this.rowInit.bind(this),this.grid.checkboxCheckCallback=this.registerProduct.bind(this),this.grid.rows.each(function(e){this.rowInit(this.grid,e)}.bind(this))},createAttributes:function(){this.attributes.each(function(e,t){var i=$(document.createElement("LI"));i.className="attribute",i.id=this.idPrefix+"_attribute_"+t,e.html_id=i.id,e&&e.label&&e.label.blank()&&(e.label="&nbsp;");var a="",n="";"1"==e.use_default&&(n=' checked="checked"',a=' readonly="readonly"');var s=this.addAttributeTemplate.evaluate(e);s=s.replace(new RegExp(' readonly="label"',"ig"),a),s=s.replace(new RegExp(' checked="use_default"',"ig"),n),i.update(s),i.attributeObject=e,this.container.appendChild(i),i.attributeValues=i.down(".attribute-values"),e.values&&e.values.each(function(e){this.createValueRow(i,e)}.bind(this)),Event.observe(i.down(".attribute-label"),"change",this.onLabelUpdate),Event.observe(i.down(".attribute-label"),"keyup",this.onLabelUpdate),Event.observe(i.down(".attribute-use-default-label"),"change",this.onLabelUpdate)}.bind(this)),this.readonly||Sortable.create(this.container,{handle:"attribute-name-container",onUpdate:this.updatePositions.bind(this)}),this.updateSaveInput()},updateLabel:function(e){var t=Event.findElement(e,"LI"),i=t.down(".attribute-label"),a=t.down(".attribute-use-default-label");t.attributeObject.label=i.value,a.checked?(i.readOnly=!0,t.attributeObject.use_default=1):(i.readOnly=!1,t.attributeObject.use_default=0),this.updateSaveInput()},updatePositions:function(){this.container.childElements().each(function(e,t){e.attributeObject.position=t}),this.updateSaveInput()},addNewProduct:function(e,t){this.checkAttributes(t)?this.links.set(e,this.cloneAttributes(t)):this.newProducts.push(e),this.updateGrid(),this.updateValues(),this.grid.reload(null)},createEmptyProduct:function(){this.createPopup(this.createEmptyUrl)},createNewProduct:function(){this.createPopup(this.createNormalUrl)},createPopup:function(e){this.win&&!this.win.closed&&this.win.close(),this.win=window.open(e,"","width=1000,height=700,resizable=1,scrollbars=1"),this.win.focus()},registerProduct:function(e,t,i){i?t.linkAttributes&&this.links.set(t.value,t.linkAttributes):this.links.unset(t.value),this.updateGrid(),this.grid.rows.each(function(e){this.revalidateRow(this.grid,e)}.bind(this)),this.updateValues()},updateProduct:function(e,t){var i=!1;"undefined"!=typeof this.links.get(e)&&(i=!0,this.links.unset(e)),i&&this.checkAttributes(t)?this.links.set(e,this.cloneAttributes(t)):i&&this.newProducts.push(e),this.updateGrid(),this.updateValues(),this.grid.reload(null)},cloneAttributes:function(e){for(var t=[],i=0,a=e.length;a>i;i++)t[i]=Object.clone(e[i]);return t},rowClick:function(e,t){var i=Event.findElement(t,"tr"),a="INPUT"==Event.element(t).tagName.toUpperCase();if(!$(Event.findElement(t,"td")).down("a")&&i){var n=$(i).down("input");if(n&&!n.disabled){var s=a?n.checked:!n.checked;e.setCheckboxChecked(n,s)}}},rowInit:function(e,t){var i=$(t).down(".checkbox"),a=$(t).down(".value-json");i&&a&&(i.linkAttributes=a.value.evalJSON(),i.checked||(this.checkAttributes(i.linkAttributes)?($(t).removeClassName("invalid"),i.enable()):($(t).addClassName("invalid"),i.disable())))},revalidateRow:function(e,t){var i=$(t).down(".checkbox");i&&(i.checked||(this.checkAttributes(i.linkAttributes)?($(t).removeClassName("invalid"),i.enable()):($(t).addClassName("invalid"),i.disable())))},checkAttributes:function(e){var t=!0;return this.links.each(function(i){for(var a=!1,n=0;n<i.value.length&&!a;n++)for(var s=0;s<e.length&&!a;s++)i.value[n].attribute_id==e[s].attribute_id&&i.value[n].value_index!=e[s].value_index&&(a=!0);a||(t=!1)}),t},updateGrid:function(){this.grid.reloadParams={"products[]":this.links.keys().size()?this.links.keys():[0],"new_products[]":this.newProducts}},updateValues:function(){var e=$H({});this.links.each(function(t){for(var i=0,a=t.value.length;a>i;i++){var n=t.value[i];-1==e.keys().indexOf(n.attribute_id)&&e.set(n.attribute_id,$H({})),e.get(n.attribute_id).set(n.value_index,n)}}),this.container.childElements().each(function(t){for(var i=t.attributeObject,a=0,n=i.values.length;n>a;a++)-1==e.keys().indexOf(i.attribute_id)||-1==e.get(i.attribute_id).keys().indexOf(i.values[a].value_index)?(t.attributeValues.childElements().each(function(e){e.valueObject.value_index==i.values[a].value_index&&e.remove()}),i.values[a]=void 0):e.get(i.attribute_id).unset(i.values[a].value_index);i.values=i.values.compact(),e.get(i.attribute_id)&&e.get(i.attribute_id).each(function(e){i.values.push(e.value),this.createValueRow(t,e.value)}.bind(this))}.bind(this)),this.updateSaveInput(),this.updateSimpleForm()},createValueRow:function(e,t){var i=$H({});this.valueAutoIndex||(this.valueAutoIndex=1),i.set("html_id",e.id+"_"+this.valueAutoIndex),i.update(t);var a=parseFloat(i.get("pricing_value"));isNaN(a)?i.unset("pricing_value"):i.set("pricing_value",a),this.valueAutoIndex++;var n=$(document.createElement("LI"));n.className="attribute-value",n.id=i.get("html_id"),n.update(this.addValueTemplate.evaluate(i)),n.valueObject=t,"undefined"==typeof n.valueObject.is_percent&&(n.valueObject.is_percent=0),"undefined"==typeof n.valueObject.pricing_value&&(n.valueObject.pricing_value=""),e.attributeValues.appendChild(n);var s=n.down(".attribute-price"),l=n.down(".attribute-price-type");void 0!=l&&void 0!=l.options&&(l.options[1].selected=parseInt(t.is_percent)?!(l.options[0].selected=!1):!(l.options[0].selected=!0)),Event.observe(s,"keyup",this.onValuePriceUpdate),Event.observe(s,"change",this.onValuePriceUpdate),Event.observe(l,"change",this.onValueTypeUpdate);var r=n.down(".attribute-use-default-value");r&&(n.valueObject.use_default_value&&(r.checked=!0,this.updateUseDefaultRow(r,n)),Event.observe(r,"change",this.onValueDefaultUpdate))},updateValuePrice:function(e){var t=Event.findElement(e,"LI");t.valueObject.pricing_value=Event.element(e).value.blank()?null:Event.element(e).value,this.updateSimpleForm(),this.updateSaveInput()},updateValueType:function(e){var t=Event.findElement(e,"LI");t.valueObject.is_percent=Event.element(e).value.blank()?null:Event.element(e).value,this.updateSimpleForm(),this.updateSaveInput()},updateValueUseDefault:function(e){var t=Event.findElement(e,"LI"),i=Event.element(e);t.valueObject.use_default_value=i.checked,this.updateUseDefaultRow(i,t)},updateUseDefaultRow:function(e,t){var i=t.down(".attribute-price"),a=t.down(".attribute-price-type");e.checked?(i.disabled=!0,a.disabled=!0):(i.disabled=!1,a.disabled=!1),this.updateSimpleForm(),this.updateSaveInput()},updateSaveInput:function(){$(this.idPrefix+"save_attributes").value=Object.toJSON(this.attributes),$(this.idPrefix+"save_links").value=Object.toJSON(this.links)},initializeAdvicesForSimpleForm:function(){$(this.idPrefix+"simple_form").advicesInited||($(this.idPrefix+"simple_form").select("td.value").each(function(e){var t=$(Builder.node("div"));e.appendChild(t),e.select("input","select").each(function(e){e.advaiceContainer=t})}),$(this.idPrefix+"simple_form").advicesInited=!0)},quickCreateNewProduct:function(){this.initializeAdvicesForSimpleForm(),$(this.idPrefix+"simple_form").removeClassName("ignore-validate");var e=$(this.idPrefix+"simple_form").select("input","select","textarea").collect(function(e){return Validation.validate(e,{useTitle:!1,onElementValidate:function(){}})}).all();if($(this.idPrefix+"simple_form").addClassName("ignore-validate"),e){var t=Form.serializeElements($(this.idPrefix+"simple_form").select("input","select","textarea"),!0);t.form_key=FORM_KEY,$("messages").update(),new Ajax.Request(this.createQuickUrl,{parameters:t,method:"post",area:$(this.idPrefix+"simple_form"),onComplete:this.quickCreateNewProductComplete.bind(this)})}},quickCreateNewProductComplete:function(e){var t=e.responseText.evalJSON();return t.error?void(t.error.fields?($(this.idPrefix+"simple_form").removeClassName("ignore-validate"),$H(t.error.fields).each(function(e){$("simple_product_"+e.key).value=e.value,$("simple_product_"+e.key+"_autogenerate").checked=!1,toggleValueElements($("simple_product_"+e.key+"_autogenerate"),$("simple_product_"+e.key+"_autogenerate").parentNode),Validation.ajaxError($("simple_product_"+e.key),t.error.message)}),$(this.idPrefix+"simple_form").addClassName("ignore-validate")):alert(t.error.message?t.error.message:t.error)):(t.messages&&$("messages").update(t.messages),t.attributes.each(function(e){var i=this.getAttributeById(e.attribute_id);!this.getValueByIndex(i,e.value_index)&&t.pricing&&t.pricing[i.attribute_code]&&(e.is_percent=t.pricing[i.attribute_code].is_percent,e.pricing_value=null==t.pricing[i.attribute_code].value?"":t.pricing[i.attribute_code].value)}.bind(this)),this.attributes.each(function(e){$("simple_product_"+e.attribute_code)&&($("simple_product_"+e.attribute_code).value="")}.bind(this)),this.links.set(t.product_id,t.attributes),this.updateGrid(),this.updateValues(),void this.grid.reload())},checkCreationUniqueAttributes:function(){var e=[];return this.attributes.each(function(t){e.push({attribute_id:t.attribute_id,value_index:$("simple_product_"+t.attribute_code).value})}.bind(this)),this.checkAttributes(e)},getAttributeByCode:function(e){var t=null;return this.attributes.each(function(i){if(i.attribute_code==e)throw t=i,$break}),t},getAttributeById:function(e){var t=null;return this.attributes.each(function(i){if(i.attribute_id==e)throw t=i,$break}),t},getValueByIndex:function(e,t){var i=null;return e.values.each(function(e){if(e.value_index==t)throw i=e,$break}),i},showPricing:function(e,t){var i=this.getAttributeByCode(t);if(i){if(e=$(e),e.value&&!$("simple_product_"+t+"_pricing_container")){Element.insert(e,{after:'<div class="left"></div> <div id="simple_product_'+t+'_pricing_container" class="left"></div>'});var a=e.next("div");e.parentNode.removeChild(e),a.appendChild(e),$(this.idPrefix+"simple_form").down(".form-list").style.width="100%"}var n=$("simple_product_"+t+"_pricing_container");if(e.value){var s=this.getValueByIndex(i,e.value);if(s)isNaN(parseFloat(s.pricing_value))?(n.update(""),$("simple_product_"+t+"_pricing_value").value=null,$("simple_product_"+t+"_pricing_type").value=null):(n.update(this.pricingValueViewTemplate.evaluate({value:(parseFloat(s.pricing_value)>0?"+":"")+parseFloat(s.pricing_value)+(parseInt(s.is_percent)>0?"%":"")})),$("simple_product_"+t+"_pricing_value").value=s.pricing_value,$("simple_product_"+t+"_pricing_type").value=s.is_percent);else if(!n.down(".attribute-price")){null==s&&(s={}),n.update(this.pricingValueTemplate.evaluate(s));var l=n.down(".attribute-price"),r=n.down(".attribute-price-type");l.attributeCode=t,l.priceField=l,l.typeField=r,r.attributeCode=t,r.priceField=l,r.typeField=r,Event.observe(l,"change",this.updateSimplePricing.bindAsEventListener(this)),Event.observe(l,"keyup",this.updateSimplePricing.bindAsEventListener(this)),Event.observe(r,"change",this.updateSimplePricing.bindAsEventListener(this)),$("simple_product_"+t+"_pricing_value").value=null,$("simple_product_"+t+"_pricing_type").value=null}}else n&&(n.update(""),$("simple_product_"+t+"_pricing_value").value=null,$("simple_product_"+t+"_pricing_type").value=null)}},updateSimplePricing:function(e){var t=Event.element(e);t.priceField.value.blank()?($("simple_product_"+t.attributeCode+"_pricing_value").value=null,$("simple_product_"+t.attributeCode+"_pricing_type").value=null):($("simple_product_"+t.attributeCode+"_pricing_value").value=t.priceField.value,$("simple_product_"+t.attributeCode+"_pricing_type").value=t.typeField.value)},updateSimpleForm:function(){this.attributes.each(function(e){$("simple_product_"+e.attribute_code)&&this.showPricing($("simple_product_"+e.attribute_code),e.attribute_code)}.bind(this))},showNoticeMessage:function(){$("assign_product_warrning").show()}};var onInitDisableFieldsList=[];Event.observe(window,"load",onCompleteDisableInited);