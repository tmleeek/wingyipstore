var tinyMceWysiwygSetup=Class.create();tinyMceWysiwygSetup.prototype={mediaBrowserOpener:null,mediaBrowserTargetElementId:null,initialize:function(e,t){this.id=e,this.config=t,varienGlobalEvents.attachEventHandler("tinymceChange",this.onChangeContent.bind(this)),this.notifyFirebug(),"undefined"==typeof tinyMceEditors&&(tinyMceEditors=$H({})),tinyMceEditors.set(this.id,this)},notifyFirebug:function(){if(firebugEnabled()&&void 0==$("fb"+this.id)){var e='<ul class="messages message-firebug" id="fb'+this.id+'"><li class="notice-msg">';e+="<ul><li>",e+="<b>"+this.config.firebug_warning_title+":</b> ",e+=this.config.firebug_warning_text,e+=' <a id="hidefb'+this.id+'" href="">'+this.config.firebug_warning_anchor+"</a>",e+="</li></ul>",e+="</li></ul>",$("buttons"+this.id).insert({before:e}),Event.observe($("hidefb"+this.id),"click",function(e){$("fb"+this.id).remove(),Event.stop(e)}.bind(this))}},setup:function(e){this.config.widget_plugin_src&&tinymce.PluginManager.load("magentowidget",this.config.widget_plugin_src),this.config.plugins&&this.config.plugins.each(function(e){tinymce.PluginManager.load(e.name,e.src)}),tinyMCE.init(this.getSettings(e))},getSettings:function(e){var t="inlinepopups,safari,pagebreak,style,layer,table,advhr,advimage,emotions,iespell,media,searchreplace,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras";this.config.widget_plugin_src&&(t="magentowidget,"+t);var i=$H({}),n="";this.config.plugins&&(this.config.plugins.each(function(e){n=e.name+","+n,i.set(e.name,e.options)}),n&&(t="-"+n+t));var o={schema:"html5",mode:void 0!=e?e:"none",elements:this.id,theme:"advanced",plugins:t,theme_advanced_buttons1:n+"magentowidget,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,fontselect,fontsizeselect",theme_advanced_buttons2:"cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,forecolor,backcolor",theme_advanced_buttons3:"tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,iespell,media,advhr,|,ltr,rtl,|,fullscreen",theme_advanced_buttons4:"insertlayer,moveforward,movebackward,absolute,|,styleprops,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,pagebreak",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:!0,convert_urls:!1,relative_urls:!1,content_css:this.config.content_css,custom_popup_css:this.config.popup_css,magentowidget_url:this.config.widget_window_url,magentoPluginsOptions:i,doctype:'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">',setup:function(e){e.onSubmit.add(function(e,t){varienGlobalEvents.fireEvent("tinymceSubmit",t)}),e.onPaste.add(function(e,t,i){varienGlobalEvents.fireEvent("tinymcePaste",i)}),e.onBeforeSetContent.add(function(e,t){varienGlobalEvents.fireEvent("tinymceBeforeSetContent",t)}),e.onSetContent.add(function(e,t){varienGlobalEvents.fireEvent("tinymceSetContent",t)}),e.onSaveContent.add(function(e,t){varienGlobalEvents.fireEvent("tinymceSaveContent",t)}),e.onChange.add(function(e,t){varienGlobalEvents.fireEvent("tinymceChange",t)}),e.onExecCommand.add(function(e,t){varienGlobalEvents.fireEvent("tinymceExecCommand",t)})}};return this.config.document_base_url&&(o.document_base_url=this.config.document_base_url),this.config.files_browser_window_url&&(o.file_browser_callback=function(e,t,i,n){varienGlobalEvents.fireEvent("open_browser_callback",{win:n,type:i,field:e})}),this.config.width&&(o.width=this.config.width),this.config.height&&(o.height=this.config.height),o},openFileBrowser:function(e){var t,i=null!==this.config.store_id?this.config.store_id:0,n=this.config.files_browser_window_url+"target_element_id/"+this.id+"/store/"+i+"/";this.mediaBrowserOpener=e.win,this.mediaBrowserTargetElementId=e.field,"undefined"!=typeof e.type&&""!=e.type?(t=this.translate("image"==e.type?"Insert Image...":"Insert Media..."),n=n+"type/"+e.type+"/"):t=this.translate("Insert File..."),MediabrowserUtility.openDialog(n,!1,!1,t,{onBeforeShow:function(e){e.element.setStyle({zIndex:300200})}})},translate:function(e){return"undefined"!=typeof Translator?Translator.translate(e):e},getMediaBrowserOpener:function(){return this.mediaBrowserOpener},getMediaBrowserTargetElementId:function(){return this.mediaBrowserTargetElementId},getToggleButton:function(){return $("toggle"+this.id)},getPluginButtons:function(){return $$("#buttons"+this.id+" > button.plugin")},turnOn:function(){this.closePopups(),this.setup(),tinyMCE.execCommand("mceAddControl",!1,this.id),this.getPluginButtons().each(function(e){e.hide()})},turnOff:function(){this.closePopups(),tinyMCE.execCommand("mceRemoveControl",!1,this.id),this.getPluginButtons().each(function(e){e.show()}),Prototype.Browser.IE&&window.setTimeout(function(){$(this.id)&&($(this.id).value=$(this.id).value)}.bind(this),0)},closePopups:function(){closeEditorPopup("widget_window"+this.id),closeEditorPopup("browser_window"+this.id)},toggle:function(){return tinyMCE.get(this.id)?(this.turnOff(),!1):(this.turnOn(),!0)},onFormValidation:function(){tinyMCE.get(this.id)&&($(this.id).value=tinyMCE.get(this.id).getContent())},onChangeContent:function(){if(this.config.tab_id){var e=$$("a[id$="+this.config.tab_id+"]")[0];void 0!=$(e)&&$(e).hasClassName("tab-item-link")&&$(e).addClassName("changed")}},makeDirectiveUrl:function(e){return this.config.directives_url.replace("directive","directive/___directive/"+e)},encodeDirectives:function(e){return e.gsub(/<([a-z0-9\-\_]+.+?)([a-z0-9\-\_]+=".*?\{\{.+?\}\}.*?".+?)>/i,function(e){var t=e[2];return t=t.gsub(/([a-z0-9\-\_]+)="(.*?)(\{\{.+?\}\})(.*?)"/i,function(e){return e[1]+'="'+e[2]+this.makeDirectiveUrl(Base64.mageEncode(e[3]))+e[4]+'"'}.bind(this)),"<"+e[1]+t+">"}.bind(this))},encodeWidgets:function(e){return e.gsub(/\{\{widget(.*?)\}\}/i,function(e){var t=this.parseAttributesString(e[1]);if(t.type){var i=t.type.replace(/\//g,"__")+".gif";this.widgetPlaceholderExist(i)||(i="default.gif");var n=this.config.widget_images_url+i,o="<img";return o+=' id="'+Base64.idEncode(e[0])+'"',o+=' src="'+n+'"',o+=' title="'+e[0].replace(/\{\{/g,"{").replace(/\}\}/g,"}").replace(/\"/g,"&quot;")+'"',o+=">"}}.bind(this))},decodeDirectives:function(e){var t=this.makeDirectiveUrl("%directive%").replace(/([$^.?*!+:=()\[\]{}|\\])/g,"\\$1"),i=new RegExp(t.replace("%directive%","([a-zA-Z0-9,_-]+)"));return e.gsub(i,function(e){return Base64.mageDecode(e[1])}.bind(this))},decodeWidgets:function(e){return e.gsub(/<img([^>]+id=\"[^>]+)>/i,function(e){var t=this.parseAttributesString(e[1]);if(t.id){var i=Base64.idDecode(t.id);return-1!=i.indexOf("{{widget")?i:e[0]}return e[0]}.bind(this))},parseAttributesString:function(e){var t={};return e.gsub(/(\w+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/,function(e){t[e[1]]=e[2]}),t},beforeSetContent:function(e){this.config.add_widgets?(e.content=this.encodeWidgets(e.content),e.content=this.encodeDirectives(e.content)):this.config.add_directives&&(e.content=this.encodeDirectives(e.content))},saveContent:function(e){this.config.add_widgets?(e.content=this.decodeWidgets(e.content),e.content=this.decodeDirectives(e.content)):this.config.add_directives&&(e.content=this.decodeDirectives(e.content))},widgetPlaceholderExist:function(e){return-1!=this.config.widget_placeholders.indexOf(e)}};