var widgetTools={getDivHtml:function(t,e){return e||(e=""),'<div id="'+t+'">'+e+"</div>"},onAjaxSuccess:function(t){if(t.responseText.isJSON()){var e=t.responseText.evalJSON();if(e.error)throw e;e.ajaxExpired&&e.ajaxRedirect&&setLocation(e.ajaxRedirect)}},openDialog:function(t){return $("widget_window")&&"undefined"!=typeof Windows?void Windows.focus("widget_window"):(this.dialogWindow=Dialog.info(null,{draggable:!0,resizable:!1,closable:!0,className:"magento",windowClassName:"popup-window",title:Translator.translate("Insert Widget..."),top:50,width:950,zIndex:1e3,recenterAuto:!1,hideEffect:Element.hide,showEffect:Element.show,id:"widget_window",onClose:this.closeDialog.bind(this)}),void new Ajax.Updater("modal_dialog_message",t,{evalScripts:!0}))},closeDialog:function(t){t||(t=this.dialogWindow),t&&(WindowUtilities._showSelect(),t.close())}},WysiwygWidget={};WysiwygWidget.Widget=Class.create(),WysiwygWidget.Widget.prototype={initialize:function(t,e,i,o,n){$(t).insert({bottom:widgetTools.getDivHtml(i)}),this.formEl=t,this.widgetEl=$(e),this.widgetOptionsEl=$(i),this.optionsUrl=o,this.optionValues=new Hash({}),this.widgetTargetId=n,"undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&(this.bMark=tinyMCE.activeEditor.selection.getBookmark()),Event.observe(this.widgetEl,"change",this.loadOptions.bind(this)),this.initOptionValues()},getOptionsContainerId:function(){return this.widgetOptionsEl.id+"_"+this.widgetEl.value.gsub(/\//,"_")},switchOptionsContainer:function(t){$$("#"+this.widgetOptionsEl.id+" div[id^="+this.widgetOptionsEl.id+"]").each(function(t){this.disableOptionsContainer(t.id)}.bind(this)),void 0!=t&&this.enableOptionsContainer(t),this._showWidgetDescription()},enableOptionsContainer:function(t){$$("#"+t+" .widget-option").each(function(t){t.removeClassName("skip-submit"),t.hasClassName("obligatory")&&(t.removeClassName("obligatory"),t.addClassName("required-entry"))}),$(t).removeClassName("no-display")},disableOptionsContainer:function(t){$(t).hasClassName("no-display")||($$("#"+t+" .widget-option").each(function(t){t.hasClassName("skip-submit")||t.addClassName("skip-submit"),t.hasClassName("required-entry")&&(t.removeClassName("required-entry"),t.addClassName("obligatory"))}),$(t).addClassName("no-display"))},initOptionValues:function(){if(!this.wysiwygExists())return!1;var t=this.getWysiwygNode();if(void 0!=t&&t.id){var e=Base64.idDecode(t.id);-1!=e.indexOf("{{widget")&&(this.optionValues=new Hash({}),e.gsub(/([a-z0-9\_]+)\s*\=\s*[\"]{1}([^\"]+)[\"]{1}/i,function(t){"type"==t[1]?this.widgetEl.value=t[2]:this.optionValues.set(t[1],t[2])}.bind(this)),this.loadOptions())}},loadOptions:function(){if(!this.widgetEl.value)return void this.switchOptionsContainer();var t=this.getOptionsContainerId();if(void 0!=$(t))return void this.switchOptionsContainer(t);this._showWidgetDescription();var e={widget_type:this.widgetEl.value,values:this.optionValues};new Ajax.Request(this.optionsUrl,{parameters:{widget:Object.toJSON(e)},onSuccess:function(e){try{widgetTools.onAjaxSuccess(e),this.switchOptionsContainer(),void 0==$(t)?this.widgetOptionsEl.insert({bottom:widgetTools.getDivHtml(t,e.responseText)}):this.switchOptionsContainer(t)}catch(i){alert(i.message)}}.bind(this)})},_showWidgetDescription:function(){var t=this.widgetEl.next().down("small"),e=$("widget-description-"+this.widgetEl.selectedIndex);if(void 0!=t){{void 0!=e?e.innerHTML:""}t.update(e.innerHTML)}},insertWidget:function(){if(widgetOptionsForm=new varienForm(this.formEl),widgetOptionsForm.validator&&widgetOptionsForm.validator.validate()||!widgetOptionsForm.validator){var t=[],e=0;Form.getElements($(this.formEl)).each(function(i){i.hasClassName("skip-submit")||(t[e]=i,e++)});var i=Form.serializeElements(t);this.wysiwygExists()||(i+="&as_is=1"),new Ajax.Request($(this.formEl).action,{parameters:i,onComplete:function(t){try{widgetTools.onAjaxSuccess(t),Windows.close("widget_window"),"undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&(tinyMCE.activeEditor.focus(),this.bMark&&tinyMCE.activeEditor.selection.moveToBookmark(this.bMark)),this.updateContent(t.responseText)}catch(e){alert(e.message)}}.bind(this)})}},updateContent:function(t){if(this.wysiwygExists())this.getWysiwyg().execCommand("mceInsertContent",!1,t);else{var e=document.getElementById(this.widgetTargetId);updateElementAtCursor(e,t),varienGlobalEvents.fireEvent("tinymceChange")}},wysiwygExists:function(){return"undefined"!=typeof tinyMCE&&tinyMCE.get(this.widgetTargetId)},getWysiwyg:function(){return tinyMCE.activeEditor},getWysiwygNode:function(){return tinyMCE.activeEditor.selection.getNode()}},WysiwygWidget.chooser=Class.create(),WysiwygWidget.chooser.prototype={chooserId:null,chooserUrl:null,config:null,dialogWindow:null,dialogContent:null,overlayShowEffectOptions:null,overlayHideEffectOptions:null,initialize:function(t,e,i){this.chooserId=t,this.chooserUrl=e,this.config=i},getResponseContainerId:function(){return"responseCnt"+this.chooserId},getChooserControl:function(){return $(this.chooserId+"control")},getElement:function(){return $(this.chooserId+"value")},getElementLabel:function(){return $(this.chooserId+"label")},open:function(){$(this.getResponseContainerId()).show()},close:function(){$(this.getResponseContainerId()).hide(),this.closeDialogWindow()},choose:function(){if(this.dialogContent)return void this.openDialogWindow(this.dialogContent);var t=this.getResponseContainerId();new Ajax.Request(this.chooserUrl,{parameters:{element_value:this.getElementValue(),element_label:this.getElementLabelText()},onSuccess:function(e){try{widgetTools.onAjaxSuccess(e),this.dialogContent=widgetTools.getDivHtml(t,e.responseText),this.openDialogWindow(this.dialogContent)}catch(i){alert(i.message)}}.bind(this)})},openDialogWindow:function(t){this.overlayShowEffectOptions=Windows.overlayShowEffectOptions,this.overlayHideEffectOptions=Windows.overlayHideEffectOptions,Windows.overlayShowEffectOptions={duration:0},Windows.overlayHideEffectOptions={duration:0},this.dialogWindow=Dialog.info(t,{draggable:!0,resizable:!0,closable:!0,className:"magento",windowClassName:"popup-window",title:this.config.buttons.open,top:50,width:950,height:500,zIndex:1e3,recenterAuto:!1,hideEffect:Element.hide,showEffect:Element.show,id:"widget-chooser",onClose:this.closeDialogWindow.bind(this)}),t.evalScripts.bind(t).defer()},closeDialogWindow:function(t){t||(t=this.dialogWindow),t&&(t.close(),Windows.overlayShowEffectOptions=this.overlayShowEffectOptions,Windows.overlayHideEffectOptions=this.overlayHideEffectOptions),this.dialogWindow=null},getElementValue:function(){return this.getElement().value},getElementLabelText:function(){return this.getElementLabel().innerHTML},setElementValue:function(t){this.getElement().value=t},setElementLabel:function(t){this.getElementLabel().innerHTML=t}};