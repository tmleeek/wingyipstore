var Packaging=Class.create();Packaging.prototype={initialize:function(e){this.packageIncrement=0,this.packages=[],this.itemsAll=[],this.createLabelUrl=e.createLabelUrl?e.createLabelUrl:null,this.itemsGridUrl=e.itemsGridUrl?e.itemsGridUrl:null,this.errorQtyOverLimit=e.errorQtyOverLimit,this.titleDisabledSaveBtn=e.titleDisabledSaveBtn,this.window=$("packaging_window"),this.windowMask=$("popup-window-mask"),this.messages=this.window.select(".messages")[0],this.packagesContent=$("packages_content"),this.template=$("package_template"),this.paramsCreateLabelRequest={},this.validationErrorMsg=e.validationErrorMsg,this.defaultItemsQty=e.shipmentItemsQty?e.shipmentItemsQty:null,this.defaultItemsPrice=e.shipmentItemsPrice?e.shipmentItemsPrice:null,this.defaultItemsName=e.shipmentItemsName?e.shipmentItemsName:null,this.defaultItemsWeight=e.shipmentItemsWeight?e.shipmentItemsWeight:null,this.defaultItemsProductId=e.shipmentItemsProductId?e.shipmentItemsProductId:null,this.defaultItemsOrderItemId=e.shipmentItemsOrderItemId?e.shipmentItemsOrderItemId:null,this.shippingInformation=e.shippingInformation?e.shippingInformation:null,this.thisPage=e.thisPage?e.thisPage:null,this.customizableContainers=e.customizable?e.customizable:[],this.eps=1e-6},setLabelCreatedCallback:function(e){this.labelCreatedCallback=e},setCancelCallback:function(e){this.cancelCallback=e},setConfirmPackagingCallback:function(e){this.confirmPackagingCallback=e},setItemQtyCallback:function(e){this.itemQtyCallback=e},setCreateLabelUrl:function(e){this.createLabelUrl=e},setParamsCreateLabelRequest:function(e){Object.extend(this.paramsCreateLabelRequest,e)},showWindow:function(){0==this.packagesContent.childElements().length&&this.newPackage(),this.window.show().setStyle({marginLeft:-this.window.getDimensions().width/2+"px"}),this.windowMask.setStyle({height:$("html-body").getHeight()+"px"}).show()},cancelPackaging:function(){packaging.window.hide(),packaging.windowMask.hide(),Object.isFunction(this.cancelCallback)&&this.cancelCallback()},confirmPackaging:function(){Object.isFunction(this.confirmPackagingCallback)&&this.confirmPackagingCallback()},checkAllItems:function(e){$(e).up("table").select('tbody input[type="checkbox"]').each(function(t){t.checked=e.checked,this._observeQty.call(t)}.bind(this))},cleanPackages:function(){this.packagesContent.update(),this.packages=[],this.itemsAll=[],this.packageIncrement=0,this._setAllItemsPackedState(),this.messages.hide().update()},sendCreateLabelRequest:function(){var e=this;if(!this.validate())return void this.messages.show().update(this.validationErrorMsg);if(this.messages.hide().update(),this.createLabelUrl){var t,a,s,i=null,n=[];this.packagesContent.childElements().each(function(e){var l=e.id.match(/\d$/)[0];t=parseFloat(e.select('input[name="container_weight"]')[0].value),a=parseFloat(e.select('input[name="container_length"]')[0].value),s=parseFloat(e.select('input[name="container_width"]')[0].value),i=parseFloat(e.select('input[name="container_height"]')[0].value),n[l]={container:e.select('select[name="package_container"]')[0].value,customs_value:parseFloat(e.select('input[name="package_customs_value"]')[0].value,10),weight:isNaN(t)?"":t,length:isNaN(a)?"":a,width:isNaN(s)?"":s,height:isNaN(i)?"":i,weight_units:e.select('select[name="container_weight_units"]')[0].value,dimension_units:e.select('select[name="container_dimension_units"]')[0].value},isNaN(n[l].customs_value)&&(n[l].customs_value=0),"undefined"!=typeof e.select('select[name="package_size"]')[0]&&""!=e.select('select[name="package_size"]')[0].value&&(n[l].size=e.select('select[name="package_size"]')[0].value),"undefined"!=typeof e.select('input[name="container_girth"]')[0]&&""!=e.select('input[name="container_girth"]')[0].value&&(n[l].girth=e.select('input[name="container_girth"]')[0].value,n[l].girth_dimension_units=e.select('select[name="container_girth_dimension_units"]')[0].value),"undefined"!=typeof e.select('select[name="content_type"]')[0]&&"undefined"!=typeof e.select('input[name="content_type_other"]')[0]?(n[l].content_type=e.select('select[name="content_type"]')[0].value,n[l].content_type_other=e.select('input[name="content_type_other"]')[0].value):(n[l].content_type="",n[l].content_type_other="");var c=e.select('select[name="delivery_confirmation_types"]');c.length&&(n[l].delivery_confirmation=c[0].value)}.bind(this));for(var l in this.packages)if(!isNaN(l)){this.paramsCreateLabelRequest["packages["+l+"][params][container]"]=n[l].container,this.paramsCreateLabelRequest["packages["+l+"][params][weight]"]=n[l].weight,this.paramsCreateLabelRequest["packages["+l+"][params][customs_value]"]=n[l].customs_value,this.paramsCreateLabelRequest["packages["+l+"][params][length]"]=n[l].length,this.paramsCreateLabelRequest["packages["+l+"][params][width]"]=n[l].width,this.paramsCreateLabelRequest["packages["+l+"][params][height]"]=n[l].height,this.paramsCreateLabelRequest["packages["+l+"][params][weight_units]"]=n[l].weight_units,this.paramsCreateLabelRequest["packages["+l+"][params][dimension_units]"]=n[l].dimension_units,this.paramsCreateLabelRequest["packages["+l+"][params][content_type]"]=n[l].content_type,this.paramsCreateLabelRequest["packages["+l+"][params][content_type_other]"]=n[l].content_type_other,"undefined"!=typeof n[l].size&&(this.paramsCreateLabelRequest["packages["+l+"][params][size]"]=n[l].size),"undefined"!=typeof n[l].girth&&(this.paramsCreateLabelRequest["packages["+l+"][params][girth]"]=n[l].girth,this.paramsCreateLabelRequest["packages["+l+"][params][girth_dimension_units]"]=n[l].girth_dimension_units),"undefined"!=typeof n[l].delivery_confirmation&&(this.paramsCreateLabelRequest["packages["+l+"][params][delivery_confirmation]"]=n[l].delivery_confirmation);for(var c in this.packages[l].items)isNaN(c)||(this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][qty]"]=this.packages[l].items[c].qty,this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][customs_value]"]=this.packages[l].items[c].customs_value,this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][price]"]=e.defaultItemsPrice[c],this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][name]"]=e.defaultItemsName[c],this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][weight]"]=e.defaultItemsWeight[c],this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][product_id]"]=e.defaultItemsProductId[c],this.paramsCreateLabelRequest["packages["+l+"][items]["+c+"][order_item_id]"]=e.defaultItemsOrderItemId[c])}if(new Ajax.Request(this.createLabelUrl,{parameters:this.paramsCreateLabelRequest,onSuccess:function(e){var t=e.responseText;t.isJSON()&&(t=t.evalJSON(),t.error?this.messages.show().innerHTML=t.message:t.ok&&Object.isFunction(this.labelCreatedCallback)&&this.labelCreatedCallback(t))}.bind(this)}),this.paramsCreateLabelRequest.code&&this.paramsCreateLabelRequest.carrier_title&&this.paramsCreateLabelRequest.method_title&&this.paramsCreateLabelRequest.price){var r=this.paramsCreateLabelRequest.code,o=this.paramsCreateLabelRequest.carrier_title,h=this.paramsCreateLabelRequest.method_title,m=this.paramsCreateLabelRequest.price;this.paramsCreateLabelRequest={},this.paramsCreateLabelRequest.code=r,this.paramsCreateLabelRequest.carrier_title=o,this.paramsCreateLabelRequest.method_title=h,this.paramsCreateLabelRequest.price=m}else this.paramsCreateLabelRequest={}}},validate:function(){var e=$("packaging_window").select("input[name=container_length],input[name=container_width],input[name=container_height]"),t=null;return t=e.any(function(e){return!!e.value})?function(e){$(e).addClassName("required-entry")}:function(e){$(e).removeClassName("required-entry")},e.each(t),result=$$('[id^="package_block_"] input').collect(function(e){return this.validateElement(e)},this).all()},validateElement:function(e){var t=$w(e.className);return result=t.all(function(t){var a=Validation.get(t);return Validation.isVisible(e)&&!a.test($F(e),e)?($(e).addClassName("validation-failed"),!1):($(e).removeClassName("validation-failed"),!0)})},validateCustomsValue:function(){var e=[],t=!0,a=[],s=[];return this.packagesContent.childElements().each(function(t){a=t.select(".package_prapare")[0],a&&(e=e.concat(a.select(".grid tbody tr"))),s=t.select(".package_items")[0],s&&(e=e.concat(s.select(".grid tbody tr")))}.bind(this)),e.each(function(e){var a=e.select('[name="customs_value"]')[0];this.validateElement(a)||(t=!1)}.bind(this)),t?this.messages.hide().update():this.messages.show().update(this.validationErrorMsg),t},newPackage:function(){var e=this.template.cloneNode(!0);e.id="package_block_"+ ++this.packageIncrement,e.addClassName("package-block"),e.select(".package-number span")[0].update(this.packageIncrement),this.packagesContent.insert({top:e}),e.select(".AddSelectedBtn")[0].hide(),e.show()},deletePackage:function(e){var t=$(e).up('div[id^="package_block"]'),a=(t.select(".package_items")[0],t.id.match(/\d$/)[0]);delete this.packages[a],t.remove(),this.messages.hide().update(),this._setAllItemsPackedState()},deleteItem:function(e){var t=$(e).up("tr"),a=t.select('[type="checkbox"]')[0].value,s=$(e).up('div[id^="package_block"]'),i=s.select(".package_items")[0],n=s.id.match(/\d$/)[0];delete this.packages[n].items[a],t.offsetParent.rows.length<=2&&$(i).hide(),t.remove(),this.messages.hide().update(),this._recalcContainerWeightAndCustomsValue(i),this._setAllItemsPackedState()},recalcContainerWeightAndCustomsValue:function(e){var t=$(e).up('div[id^="package_block"]'),a=t.select(".package_items")[0];if(a){if(!this.validateCustomsValue())return;this._recalcContainerWeightAndCustomsValue(a)}},getItemsForPack:function(e){if(this.itemsGridUrl){var t=$H({shipment_id:this.shipmentId}),a=$(e).up('[id^="package_block"]'),s=a.select(".package_prapare")[0],i=s.select(".grid_prepare")[0];new Ajax.Request(this.itemsGridUrl,{parameters:t,onSuccess:function(e){var t=e.responseText;t&&(i.update(t),this._processPackagePrapare(i),i.select(".grid tbody tr").length?(a.select(".AddItemsBtn")[0].hide(),a.select(".AddSelectedBtn")[0].show(),s.show()):i.update())}.bind(this)})}},getPackedItemsQty:function(){var e=[];for(var t in this.packages)if(!isNaN(t))for(var a in this.packages[t].items)isNaN(a)||(e[a]?e[a]+=this.packages[t].items[a].qty:e[a]=this.packages[t].items[a].qty);return e},_parseQty:function(e){var t=$(e).hasClassName("qty-decimal")?parseFloat(e.value):parseInt(e.value);return(isNaN(t)||0>=t)&&(t=1),t},packItems:function(e){var t=!1,a=$(e).up('[id^="package_block"]'),s=a.id.match(/\d$/)[0],i=a.select(".package_prapare")[0],n=i.select(".grid_prepare")[0],l=!1;if(this.messages.hide().update(),n.select(".grid tbody tr").each(function(e){var t=e.select('[type="checkbox"]')[0],a=t.value,s=this._parseQty(e.select('[name="qty"]')[0]);e.select('[name="qty"]')[0].value=s,t.checked&&this._checkExceedsQty(a,s)&&(this.messages.show().update(this.errorQtyOverLimit),l=!0)}.bind(this)),!l&&this.validateCustomsValue()){if(n.select(".grid tbody tr").each(function(e){var a=e.select('[type="checkbox"]')[0];if(a.checked){var s=e.select('[name="qty"]')[0],i=this._parseQty(s);e.select('[name="qty"]')[0].value=i,t=!0,s.disabled="disabled",a.up("td").hide(),n.select('.grid th [type="checkbox"]')[0].up("th").hide(),e.select(".delete")[0].show()}else e.remove()}.bind(this)),t){var c=a.select(".package_items")[0];c?(n.select(".grid tbody tr").each(function(e){var t=e.select('[type="checkbox"]')[0].value,a=parseFloat(e.select('[name="qty"]')[0].value);if(a=0>=a?1:a,"undefined"==typeof this.packages[s].items[t])this.packages[s].items[t]={},this.packages[s].items[t].qty=a,c.select(".grid tbody")[0].insert(e);else{this.packages[s].items[t].qty+=a;var i=c.select('[type="checkbox"][value="'+t+'"]')[0].up("tr").select('[name="qty"]')[0];i.value=this.packages[s].items[t].qty}}.bind(this)),n.update()):(i.insert(new Element("div").addClassName("grid_prepare")),i.insert({after:n}),c=n.removeClassName("grid_prepare").addClassName("package_items"),c.select(".grid tbody tr").each(function(e){var t=e.select('[type="checkbox"]')[0].value,a=parseFloat(e.select('[name="qty"]')[0].value);a=0>=a?1:a,"undefined"==typeof this.packages[s]&&(this.packages[s]={items:[],params:{}}),"undefined"==typeof this.packages[s].items[t]?(this.packages[s].items[t]={},this.packages[s].items[t].qty=a):this.packages[s].items[t].qty+=a}.bind(this))),$(c).show(),this._recalcContainerWeightAndCustomsValue(c)}else n.update();i.hide(),a.select(".AddSelectedBtn")[0].hide(),a.select(".AddItemsBtn")[0].show(),this._setAllItemsPackedState()}},validateItemQty:function(e,t){return this.defaultItemsQty[e]<t?this.defaultItemsQty[e]:t},changeMeasures:function(e){var t=0,a=0;e.childElements().each(function(e){e.selected&&(a=t),t++}.bind(this));var s=$(e).up('[id^="package_block"]');s.select(".measures").each(function(t){if(t.name!=e.name){var s=0;t.select("option").each(function(e){s==a&&(t.value=e.value),s++}.bind(this))}}.bind(this))},checkSizeAndGirthParameter:function(e,t){if(0!=t){for(var a=e;"TBODY"!=a.nodeName;)a=a.parentNode;if(a){var s=a.select("select[name=package_size]"),n=a.select("select[name=package_container]"),l=a.select("input[name=container_girth]"),c=a.select("select[name=container_girth_dimension_units]");if(!(s.length<=0)){var r="LARGE"==s[0].value&&("NONRECTANGULAR"==n[0].value||"VARIABLE"==n[0].value);r?(l[0].enable(),l[0].removeClassName("disabled"),c[0].enable(),c[0].removeClassName("disabled")):(l[0].value="",l[0].disable(),l[0].addClassName("disabled"),c[0].disable(),c[0].addClassName("disabled"));var o="NONRECTANGULAR"==n[0].value||"RECTANGULAR"==n[0].value||"VARIABLE"==n[0].value;if(o){for(i=0;i<s[0].length;i++)""==s[0].options[i].value&&s[0].removeChild(s[0].options[i]);s[0].enable(),s[0].removeClassName("disabled")}else option=document.createElement("OPTION"),option.value="",option.text="",s[0].options.add(option),s[0].value="",s[0].disable(),s[0].addClassName("disabled")}}}},changeContainerType:function(e){if(!(this.customizableContainers.length<=0)){var t=!0;for(var a in this.customizableContainers)if(this.customizableContainers[a]==e.value){t=!1;break}for(var s=e;"TBODY"!=s.nodeName;)s=s.parentNode;s&&$(s).select("input[name=container_length],input[name=container_width],input[name=container_height],select[name=container_dimension_units]").each(function(e){t?(Form.Element.disable(e),e.addClassName("disabled"),"INPUT"==e.nodeName&&($(e).value="")):(Form.Element.enable(e),e.removeClassName("disabled"))})}},changeContentTypes:function(e){var t=$(e).up('[id^="package_block"]'),a=t.select("[name=content_type]")[0],s=t.select("[name=content_type_other]")[0];"OTHER"==a.value?(Form.Element.enable(s),s.removeClassName("disabled")):(Form.Element.disable(s),s.addClassName("disabled"))},_getItemsCount:function(e){var t=0;return e.each(function(e){isNaN(e)||(t+=parseFloat(e))}.bind(this)),t},_setAllItemsPackedState:function(){var e=this.window.select(".AddPackageBtn")[0],t=this.window.select(".SavePackagesBtn")[0];if(this._getItemsCount(this.itemsAll)>0&&this._checkExceedsQtyFinal(this._getItemsCount(this.getPackedItemsQty()),this._getItemsCount(this.itemsAll))){this.packagesContent.select(".AddItemsBtn").each(function(e){e.disabled="disabled",e.addClassName("disabled")}),e.addClassName("disabled"),Form.Element.disable(e),t.removeClassName("disabled"),Form.Element.enable(t),t.title="";var a=[];this.packagesContent.childElements().each(function(e){e.select(".package_items .grid tbody tr").length||e.remove()}.bind(this));var s=this.packagesContent.childElements().length;this.packageIncrement=s,this.packagesContent.childElements().each(function(e){var t=e.id.match(/\d$/)[0];e.id="package_block_"+s,e.select(".package-number span")[0].update(s),a[s]=this.packages[t],--s}.bind(this)),this.packages=a}else this.packagesContent.select(".AddItemsBtn").each(function(e){e.removeClassName("disabled"),Form.Element.enable(e)}),e.removeClassName("disabled"),Form.Element.enable(e),t.addClassName("disabled"),Form.Element.disable(t),t.title=this.titleDisabledSaveBtn},_processPackagePrapare:function(e){var t=[];e.select(".grid tbody tr").each(function(e){var a=e.select('[name="qty"]')[0],s=e.select('[type="checkbox"]')[0].value,i=0;if(Object.isFunction(this.itemQtyCallback)){var n=this.itemQtyCallback(s);i="string"==typeof n&&0==n.length?0:parseFloat(n),(isNaN(i)||0>i)&&(i=1),i=this.validateItemQty(s,i),a.value=i}else{var n=e.select('[name="qty"]')[0].value;i="string"==typeof n&&0==n.length?0:parseFloat(n),(isNaN(i)||0>i)&&(i=1)}if(0==i)return void e.remove();var l=this.getPackedItemsQty();t[s]=i;for(var c in l)if(!isNaN(c)){var r=l[c];s==c&&(i==r||r>=i?e.remove():i>r&&(a.value=Number((i-r).toFixed(4))))}}.bind(this)),this.itemsAll.length||(this.itemsAll=t),e.select('tbody input[type="checkbox"]').each(function(e){$(e).observe("change",this._observeQty),this._observeQty.call(e)}.bind(this))},_observeQty:function(){var e=this.parentNode.parentNode,t=$(e.cells[e.cells.length-1]).select('input[name="qty"]')[0];(t.disabled=!this.checked)?$(t).addClassName("disabled"):$(t).removeClassName("disabled")},_checkExceedsQty:function(e,t){var a=this.getPackedItemsQty()[e]?this.getPackedItemsQty()[e]:0,s=this.itemsAll[e];return t*(1-this.eps)>s*(1+this.eps)-a*(1-this.eps)},_checkExceedsQtyFinal:function(e,t){return e*(1+this.eps)>=t*(1-this.eps)},_recalcContainerWeightAndCustomsValue:function(e){var t=e.up('[id^="package_block"]'),a=t.id.match(/\d$/)[0],s=t.select('[name="container_weight"]')[0],i=t.select('[name="package_customs_value"]')[0];s.value=0,i.value=0,e.select(".grid tbody tr").each(function(e){var t=e.select('[type="checkbox"]')[0].value,n=parseFloat(e.select('[name="qty"]')[0].value);(isNaN(n)||0>=n)&&(n=1,e.select('[name="qty"]')[0].value=n);var l=parseFloat(this._getElementText(e.select(".weight")[0]));s.value=parseFloat(s.value)+l*n;var c=parseFloat(e.select('[name="customs_value"]')[0].value)||0;i.value=parseFloat(i.value)+c*n,this.packages[a].items[t].customs_value=c}.bind(this)),s.value=parseFloat(parseFloat(s.value).toFixed(4)),i.value=parseFloat(i.value).toFixed(2),0==i.value&&(i.value="")},_getElementText:function(e){return"string"==typeof e.textContent?e.textContent:"string"==typeof e.innerText?e.innerText:e.innerHTML.replace(/<[^>]*>/g,"")}};